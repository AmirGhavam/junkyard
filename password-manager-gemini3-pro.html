<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecurePass Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Custom Toast Animation */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        .toast {
            animation: slideIn 0.3s ease-out forwards;
        }

        .toast.hiding {
            animation: fadeOut 0.3s ease-in forwards;
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-100 h-screen overflow-hidden flex flex-col">

    <!-- Auth Screen -->
    <div id="authScreen" class="fixed inset-0 z-50 bg-slate-900 flex flex-col items-center justify-center p-4">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-slate-700">
            <div class="text-center mb-8">
                <i class="fa-solid fa-shield-halved text-5xl text-emerald-500 mb-4"></i>
                <h1 class="text-3xl font-bold text-white">SecurePass</h1>
                <p class="text-slate-400 mt-2" id="authMessage">Enter your Master Password to unlock.</p>
            </div>

            <form id="authForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-1">Master Password</label>
                    <div class="relative">
                        <input type="password" id="masterPassword"
                            class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition-all"
                            placeholder="••••••••" required>
                        <button type="button" id="toggleMasterParams"
                            class="absolute right-3 top-3 text-slate-500 hover:text-white">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div id="confirmPasswordGroup" class="hidden">
                    <label class="block text-sm font-medium text-slate-400 mb-1">Confirm Password</label>
                    <input type="password" id="confirmMasterPassword"
                        class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-emerald-500 transition-all"
                        placeholder="••••••••">
                </div>

                <button type="submit"
                    class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg transition-colors flex justify-center items-center gap-2">
                    <span id="authButtonText">Unlock Vault</span>
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
            </form>

            <div class="mt-6 text-center">
                <p class="text-xs text-slate-500">
                    <i class="fa-solid fa-lock mr-1"></i> Data is encrypted locally in your browser.
                </p>
                <button id="resetVaultBtn" class="mt-4 text-xs text-red-500 hover:text-red-400 underline">Reset Vault
                    (Clears All Data)</button>
            </div>
        </div>
    </div>

    <!-- App Interface -->
    <div id="appInterface" class="flex-1 flex hidden h-full">
        <!-- Sidebar -->
        <aside
            class="w-20 lg:w-64 bg-slate-800 border-r border-slate-700 flex flex-col justify-between transition-all duration-300">
            <div>
                <div class="h-16 flex items-center justify-center lg:justify-start lg:px-6 border-b border-slate-700">
                    <i class="fa-solid fa-shield-halved text-2xl text-emerald-500 lg:mr-3"></i>
                    <span class="font-bold text-xl hidden lg:block">SecurePass</span>
                </div>

                <nav class="mt-6 px-2 space-y-2">
                    <button onclick="switchTab('vault')" id="nav-vault"
                        class="w-full flex items-center justify-center lg:justify-start px-4 py-3 rounded-lg text-slate-300 hover:bg-slate-700 hover:text-white transition-colors bg-slate-700 text-white">
                        <i class="fa-solid fa-vault w-6 text-center"></i>
                        <span class="ml-3 hidden lg:block">Vault</span>
                    </button>
                    <button onclick="switchTab('generator')" id="nav-generator"
                        class="w-full flex items-center justify-center lg:justify-start px-4 py-3 rounded-lg text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">
                        <i class="fa-solid fa-key w-6 text-center"></i>
                        <span class="ml-3 hidden lg:block">Generator</span>
                    </button>
                    <button onclick="switchTab('settings')" id="nav-settings"
                        class="w-full flex items-center justify-center lg:justify-start px-4 py-3 rounded-lg text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">
                        <i class="fa-solid fa-cog w-6 text-center"></i>
                        <span class="ml-3 hidden lg:block">Settings</span>
                    </button>
                </nav>
            </div>

            <div class="p-4 border-t border-slate-700">
                <button onclick="lockVault()"
                    class="w-full flex items-center justify-center lg:justify-start px-4 py-3 rounded-lg text-red-400 hover:bg-red-500/10 transition-colors">
                    <i class="fa-solid fa-lock w-6 text-center"></i>
                    <span class="ml-3 hidden lg:block">Lock Vault</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-full overflow-hidden bg-slate-900 relative">

            <!-- Top Bar -->
            <header
                class="h-16 bg-slate-800 border-b border-slate-700 flex items-center justify-between px-6 shadow-sm z-10">
                <h2 id="pageTitle" class="text-xl font-semibold text-white">My Vault</h2>
                <div class="flex items-center gap-4">
                    <div class="relative hidden sm:block">
                        <i
                            class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="searchInput" placeholder="Search passwords..."
                            class="bg-slate-900 border border-slate-700 rounded-full py-2 pl-10 pr-4 text-sm text-white focus:outline-none focus:border-emerald-500 w-64">
                    </div>
                    <button onclick="openModal()"
                        class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors shadow-lg shadow-emerald-600/20 flex items-center gap-2">
                        <i class="fa-solid fa-plus"></i>
                        <span class="hidden sm:inline">Add Item</span>
                    </button>
                </div>
            </header>

            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto p-6 scrollbar-hide relative">

                <!-- Vault Tab -->
                <div id="tab-vault" class="space-y-6 max-w-5xl mx-auto">
                    <!-- Empty State -->
                    <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-slate-500">
                        <div class="bg-slate-800 p-6 rounded-full mb-4">
                            <i class="fa-solid fa-safe text-4xl text-slate-600"></i>
                        </div>
                        <h3 class="text-xl font-medium text-slate-300">Your vault is empty</h3>
                        <p class="mt-2 text-sm">Add your first password to get started.</p>
                        <button onclick="openModal()"
                            class="mt-6 text-emerald-500 hover:text-emerald-400 font-medium">Add Password</button>
                    </div>

                    <!-- Password Grid -->
                    <div id="passwordGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                        <!-- Cards will be injected here via JS -->
                    </div>
                </div>

                <!-- Generator Tab -->
                <div id="tab-generator" class="hidden max-w-2xl mx-auto py-8">
                    <div class="bg-slate-800 rounded-2xl shadow-xl border border-slate-700 overflow-hidden">
                        <div class="p-8 border-b border-slate-700 bg-slate-800/50">
                            <div class="relative">
                                <input type="text" id="generatedPassword" readonly
                                    class="w-full bg-slate-900 text-2xl font-mono text-center py-6 px-4 rounded-xl border-2 border-slate-700 focus:outline-none focus:border-emerald-500 text-emerald-400 tracking-wider"
                                    value="P@ssw0rd123!">
                                <div class="absolute right-4 top-1/2 transform -translate-y-1/2 flex gap-2">
                                    <button
                                        onclick="copyToClipboard(document.getElementById('generatedPassword').value)"
                                        class="p-2 text-slate-400 hover:text-white transition-colors" title="Copy">
                                        <i class="fa-regular fa-copy text-xl"></i>
                                    </button>
                                    <button onclick="generatePassword()"
                                        class="p-2 text-emerald-500 hover:text-emerald-400 transition-colors"
                                        title="Regenerate">
                                        <i class="fa-solid fa-rotate text-xl"></i>
                                    </button>
                                </div>
                            </div>
                            <!-- Strength Indicator -->
                            <div class="mt-4 flex gap-1 h-1.5 w-full rounded-full overflow-hidden bg-slate-700"
                                id="strengthBar">
                                <div class="w-1/4 bg-red-500"></div>
                                <div class="w-1/4 bg-yellow-500"></div>
                                <div class="w-1/4 bg-blue-500"></div>
                                <div class="w-1/4 bg-emerald-500"></div>
                            </div>
                            <p class="text-center text-sm text-emerald-400 mt-2 font-medium" id="strengthText">Strong
                            </p>
                        </div>

                        <div class="p-8 space-y-6">
                            <div>
                                <div class="flex justify-between mb-2">
                                    <label class="text-slate-300 font-medium">Password Length</label>
                                    <span id="lengthValue" class="text-emerald-500 font-bold text-lg">16</span>
                                </div>
                                <input type="range" id="passLength" min="6" max="64" value="16"
                                    class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-emerald-500">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <label
                                    class="flex items-center gap-3 p-4 bg-slate-900 rounded-lg border border-slate-700 cursor-pointer hover:border-slate-600 transition-colors">
                                    <input type="checkbox" id="incUppercase" checked
                                        class="w-5 h-5 rounded border-slate-600 text-emerald-600 focus:ring-emerald-500 bg-slate-800">
                                    <span class="text-slate-300">A-Z Uppercase</span>
                                </label>
                                <label
                                    class="flex items-center gap-3 p-4 bg-slate-900 rounded-lg border border-slate-700 cursor-pointer hover:border-slate-600 transition-colors">
                                    <input type="checkbox" id="incLowercase" checked
                                        class="w-5 h-5 rounded border-slate-600 text-emerald-600 focus:ring-emerald-500 bg-slate-800">
                                    <span class="text-slate-300">a-z Lowercase</span>
                                </label>
                                <label
                                    class="flex items-center gap-3 p-4 bg-slate-900 rounded-lg border border-slate-700 cursor-pointer hover:border-slate-600 transition-colors">
                                    <input type="checkbox" id="incNumbers" checked
                                        class="w-5 h-5 rounded border-slate-600 text-emerald-600 focus:ring-emerald-500 bg-slate-800">
                                    <span class="text-slate-300">0-9 Numbers</span>
                                </label>
                                <label
                                    class="flex items-center gap-3 p-4 bg-slate-900 rounded-lg border border-slate-700 cursor-pointer hover:border-slate-600 transition-colors">
                                    <input type="checkbox" id="incSymbols" checked
                                        class="w-5 h-5 rounded border-slate-600 text-emerald-600 focus:ring-emerald-500 bg-slate-800">
                                    <span class="text-slate-300">!@# Symbols</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="tab-settings" class="hidden max-w-2xl mx-auto py-8">
                    <div class="bg-slate-800 rounded-2xl p-8 border border-slate-700">
                        <h3 class="text-xl font-bold text-white mb-6">Security Settings</h3>

                        <div class="space-y-6">
                            <div
                                class="flex items-center justify-between p-4 bg-slate-900 rounded-xl border border-slate-700">
                                <div>
                                    <h4 class="font-medium text-white">Export Data</h4>
                                    <p class="text-sm text-slate-400">Download your encrypted vault as a JSON file.</p>
                                </div>
                                <button onclick="exportData()"
                                    class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                                    <i class="fa-solid fa-download mr-2"></i> Export
                                </button>
                            </div>

                            <div
                                class="flex items-center justify-between p-4 bg-slate-900 rounded-xl border border-slate-700">
                                <div>
                                    <h4 class="font-medium text-white">Import Data</h4>
                                    <p class="text-sm text-slate-400">Restore your vault from a backup file.</p>
                                </div>
                                <label
                                    class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors cursor-pointer">
                                    <i class="fa-solid fa-upload mr-2"></i> Import
                                    <input type="file" id="importFile" class="hidden" accept=".json"
                                        onchange="importData(this)">
                                </label>
                            </div>

                            <div class="border-t border-slate-700 pt-6">
                                <h4 class="font-medium text-red-400 mb-2">Danger Zone</h4>
                                <div
                                    class="flex items-center justify-between p-4 bg-red-900/10 border border-red-900/30 rounded-xl">
                                    <div>
                                        <h4 class="font-medium text-red-400">Delete All Data</h4>
                                        <p class="text-sm text-red-300/60">Permanently remove all passwords and reset
                                            the app.</p>
                                    </div>
                                    <button onclick="resetVault()"
                                        class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Add/Edit Modal -->
    <div id="itemModal"
        class="fixed inset-0 z-40 bg-black/70 hidden backdrop-blur-sm flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-slate-800 rounded-2xl w-full max-w-lg shadow-2xl border border-slate-700 transform scale-95 transition-transform duration-300"
            id="modalContent">
            <div class="flex justify-between items-center p-6 border-b border-slate-700">
                <h3 class="text-xl font-bold text-white" id="modalTitle">Add Password</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white transition-colors">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <form id="itemForm" class="p-6 space-y-4">
                <input type="hidden" id="itemId">

                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-1">Service Name / Website</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-slate-500"><i class="fa-solid fa-globe"></i></span>
                        <input type="text" id="itemName"
                            class="w-full bg-slate-900 border border-slate-700 rounded-lg pl-10 pr-4 py-2.5 text-white focus:outline-none focus:border-emerald-500"
                            placeholder="e.g. Google, Netflix" required>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-1">Username / Email</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-slate-500"><i class="fa-solid fa-user"></i></span>
                        <input type="text" id="itemUsername"
                            class="w-full bg-slate-900 border border-slate-700 rounded-lg pl-10 pr-4 py-2.5 text-white focus:outline-none focus:border-emerald-500"
                            placeholder="email@example.com">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-1">Password</label>
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <span class="absolute left-3 top-3 text-slate-500"><i class="fa-solid fa-key"></i></span>
                            <input type="password" id="itemPassword"
                                class="w-full bg-slate-900 border border-slate-700 rounded-lg pl-10 pr-10 py-2.5 text-white focus:outline-none focus:border-emerald-500"
                                placeholder="••••••••" required>
                            <button type="button" onclick="toggleInputVisibility('itemPassword')"
                                class="absolute right-3 top-3 text-slate-500 hover:text-white">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                        <button type="button" onclick="fillRandomPass()"
                            class="bg-slate-700 hover:bg-slate-600 text-white px-3 rounded-lg" title="Generate Random">
                            <i class="fa-solid fa-dice"></i>
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-1">Website URL (Optional)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-slate-500"><i class="fa-solid fa-link"></i></span>
                        <input type="url" id="itemUrl"
                            class="w-full bg-slate-900 border border-slate-700 rounded-lg pl-10 pr-4 py-2.5 text-white focus:outline-none focus:border-emerald-500"
                            placeholder="https://example.com">
                    </div>
                </div>

                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" onclick="closeModal()"
                        class="px-5 py-2.5 rounded-lg text-slate-300 hover:bg-slate-700 transition-colors">Cancel</button>
                    <button type="submit"
                        class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-lg font-medium transition-colors shadow-lg shadow-emerald-600/20">Save
                        Password</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-6 right-6 z-50 flex flex-col gap-3"></div>

    <script>
        // --- State Management ---
        let vaultData = [];
        let encryptionKey = null;
        let isSetupMode = false;

        // --- DOM Elements ---
        const authScreen = document.getElementById('authScreen');
        const appInterface = document.getElementById('appInterface');
        const authForm = document.getElementById('authForm');
        const masterPasswordInput = document.getElementById('masterPassword');
        const confirmPasswordGroup = document.getElementById('confirmPasswordGroup');
        const confirmMasterPasswordInput = document.getElementById('confirmMasterPassword');
        const authButtonText = document.getElementById('authButtonText');
        const authMessage = document.getElementById('authMessage');
        const passwordGrid = document.getElementById('passwordGrid');
        const searchInput = document.getElementById('searchInput');

        // --- Initialization ---
        window.addEventListener('load', () => {
            const storedData = localStorage.getItem('securePassVault');
            if (!storedData) {
                isSetupMode = true;
                setupModeUI();
            } else {
                loginModeUI();
            }
        });

        function setupModeUI() {
            authMessage.textContent = "Create a Master Password to secure your vault.";
            confirmPasswordGroup.classList.remove('hidden');
            authButtonText.textContent = "Create Vault";
            masterPasswordInput.placeholder = "Create Password";
            confirmMasterPasswordInput.setAttribute('required', 'true');
        }

        function loginModeUI() {
            authMessage.textContent = "Enter your Master Password to unlock.";
            confirmPasswordGroup.classList.add('hidden');
            authButtonText.textContent = "Unlock Vault";
            masterPasswordInput.placeholder = "Enter Password";
            confirmMasterPasswordInput.removeAttribute('required');
        }

        // --- Auth & Crypto ---
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = masterPasswordInput.value;

            if (isSetupMode) {
                const confirm = confirmMasterPasswordInput.value;
                if (password !== confirm) {
                    showToast('Passwords do not match!', 'error');
                    return;
                }
                if (password.length < 4) {
                    showToast('Password is too short!', 'error');
                    return;
                }

                await initializeVault(password);
            } else {
                await unlockVault(password);
            }
        });

        // Derive a key from the password
        async function deriveKey(password, salt) {
            const enc = new TextEncoder();
            const keyMaterial = await window.crypto.subtle.importKey(
                "raw",
                enc.encode(password),
                { name: "PBKDF2" },
                false,
                ["deriveKey"]
            );

            return window.crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: salt,
                    iterations: 100000,
                    hash: "SHA-256"
                },
                keyMaterial,
                { name: "AES-GCM", length: 256 },
                true,
                ["encrypt", "decrypt"]
            );
        }

        async function initializeVault(password) {
            try {
                const salt = window.crypto.getRandomValues(new Uint8Array(16));
                encryptionKey = await deriveKey(password, salt);

                // Set current salt for session
                window.currentSalt = salt;

                // Save empty vault with new key
                vaultData = [];
                await saveVault(salt);

                unlockUI();
                showToast('Vault created successfully!', 'success');
            } catch (e) {
                console.error(e);
                showToast('Failed to create vault.', 'error');
            }
        }

        async function unlockVault(password) {
            try {
                const stored = JSON.parse(localStorage.getItem('securePassVault'));
                if (!stored) return;

                // Decode salt from base64
                const salt = Uint8Array.from(atob(stored.salt), c => c.charCodeAt(0));
                const iv = Uint8Array.from(atob(stored.iv), c => c.charCodeAt(0));
                const data = Uint8Array.from(atob(stored.data), c => c.charCodeAt(0));

                const key = await deriveKey(password, salt);

                // Try to decrypt
                const decryptedBuffer = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: iv },
                    key,
                    data
                );

                const dec = new TextDecoder();
                vaultData = JSON.parse(dec.decode(decryptedBuffer));
                encryptionKey = key;

                // Store salt for re-saving later if needed (though we usually generate new IVs)
                window.currentSalt = salt;

                unlockUI();
                showToast('Vault unlocked!', 'success');

            } catch (e) {
                console.error(e);
                showToast('Incorrect password.', 'error');
                masterPasswordInput.value = '';
                masterPasswordInput.focus();
                // Shake animation
                const formContainer = document.querySelector('#authForm').parentElement;
                formContainer.classList.add('animate-pulse');
                setTimeout(() => formContainer.classList.remove('animate-pulse'), 500);
            }
        }

        async function saveVault(salt = window.currentSalt) {
            if (!encryptionKey) return;

            const enc = new TextEncoder();
            const data = enc.encode(JSON.stringify(vaultData));
            const iv = window.crypto.getRandomValues(new Uint8Array(12));

            const encrypted = await window.crypto.subtle.encrypt(
                { name: "AES-GCM", iv: iv },
                encryptionKey,
                data
            );

            // Convert to base64 for storage
            const b64Data = btoa(String.fromCharCode(...new Uint8Array(encrypted)));
            const b64Iv = btoa(String.fromCharCode(...iv));
            const b64Salt = btoa(String.fromCharCode(...salt));

            localStorage.setItem('securePassVault', JSON.stringify({
                salt: b64Salt,
                iv: b64Iv,
                data: b64Data
            }));
        }

        function unlockUI() {
            authScreen.classList.add('hidden');
            appInterface.classList.remove('hidden');
            renderVault();
            generatePassword(); // Pre-generate a password for the tab
        }

        function lockVault() {
            vaultData = [];
            encryptionKey = null;
            appInterface.classList.add('hidden');
            authScreen.classList.remove('hidden');
            masterPasswordInput.value = '';
            confirmMasterPasswordInput.value = '';
            isSetupMode = false;
            loginModeUI();
        }

        function resetVault() {
            if (confirm("Are you sure you want to delete all your passwords? This cannot be undone.")) {
                localStorage.removeItem('securePassVault');
                location.reload();
            }
        }

        document.getElementById('resetVaultBtn').addEventListener('click', (e) => {
            e.preventDefault();
            resetVault();
        });

        document.getElementById('toggleMasterParams').addEventListener('click', () => {
            const type = masterPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            masterPasswordInput.setAttribute('type', type);
            if (confirmMasterPasswordInput) confirmMasterPasswordInput.setAttribute('type', type);
        });

        // --- App Logic ---

        // Navigation
        function switchTab(tabId) {
            document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');

            // Update Active State
            document.querySelectorAll('nav button').forEach(el => {
                el.classList.remove('bg-slate-700', 'text-white');
                el.classList.add('text-slate-300');
            });
            const activeBtn = document.getElementById(`nav-${tabId}`);
            activeBtn.classList.add('bg-slate-700', 'text-white');
            activeBtn.classList.remove('text-slate-300');

            const titles = { 'vault': 'My Vault', 'generator': 'Password Generator', 'settings': 'Settings' };
            document.getElementById('pageTitle').textContent = titles[tabId];
        }

        // Vault Rendering
        function renderVault() {
            const grid = document.getElementById('passwordGrid');
            grid.innerHTML = '';

            const filter = searchInput.value.toLowerCase();
            const filteredData = vaultData.filter(item =>
                item.name.toLowerCase().includes(filter) ||
                item.username.toLowerCase().includes(filter)
            );

            if (filteredData.length === 0) {
                if (filter) {
                    grid.innerHTML = `<p class="col-span-full text-center text-slate-500 py-10">No matches found.</p>`;
                } else {
                    document.getElementById('emptyState').classList.remove('hidden');
                }
                return;
            }

            document.getElementById('emptyState').classList.add('hidden');

            filteredData.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-slate-800 rounded-xl p-5 border border-slate-700 shadow-lg hover:border-emerald-500/50 transition-colors group relative';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-emerald-900/30 flex items-center justify-center text-emerald-500 text-lg font-bold">
                                ${item.name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <h3 class="font-bold text-white text-lg leading-tight">${escapeHtml(item.name)}</h3>
                                <p class="text-xs text-slate-400 truncate max-w-[150px]">${escapeHtml(item.username)}</p>
                            </div>
                        </div>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="editItem('${item.id}')" class="p-2 text-slate-400 hover:text-emerald-400 rounded-lg hover:bg-slate-700 transition-colors">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button onclick="deleteItem('${item.id}')" class="p-2 text-slate-400 hover:text-red-400 rounded-lg hover:bg-slate-700 transition-colors">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-slate-900 rounded-lg p-3 flex justify-between items-center mb-3 border border-slate-800">
                        <input type="password" value="${escapeHtml(item.password)}" readonly class="bg-transparent border-none focus:outline-none text-slate-300 w-full font-mono text-sm tracking-widest" id="pass-${item.id}">
                        <div class="flex gap-2 ml-2">
                             <button onclick="toggleCardPassword('${item.id}')" class="text-slate-500 hover:text-white transition-colors">
                                <i class="fa-solid fa-eye" id="eye-${item.id}"></i>
                            </button>
                            <button onclick="copyToClipboard('${escapeJs(item.password)}')" class="text-slate-500 hover:text-emerald-500 transition-colors">
                                <i class="fa-regular fa-copy"></i>
                            </button>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mt-2">
                        ${item.url ? `<a href="${escapeHtml(item.url)}" target="_blank" class="text-xs text-emerald-500 hover:underline flex items-center gap-1"><i class="fa-solid fa-external-link-alt"></i> Launch</a>` : '<span class="text-xs text-slate-600">No URL</span>'}
                        <button onclick="copyToClipboard('${escapeJs(item.username)}')" class="text-xs text-slate-500 hover:text-white transition-colors">Copy Username</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        searchInput.addEventListener('input', renderVault);

        // CRUD
        const itemModal = document.getElementById('itemModal');
        const itemForm = document.getElementById('itemForm');

        function openModal(editId = null) {
            itemForm.reset();
            document.getElementById('itemId').value = '';
            document.getElementById('modalTitle').textContent = 'Add Password';

            if (editId) {
                const item = vaultData.find(i => i.id === editId);
                if (item) {
                    document.getElementById('itemId').value = item.id;
                    document.getElementById('itemName').value = item.name;
                    document.getElementById('itemUsername').value = item.username;
                    document.getElementById('itemPassword').value = item.password;
                    document.getElementById('itemUrl').value = item.url || '';
                    document.getElementById('modalTitle').textContent = 'Edit Password';
                }
            }

            itemModal.classList.remove('hidden');
            // Allow display:block to apply before opacity transition
            requestAnimationFrame(() => {
                itemModal.classList.remove('opacity-0');
                document.getElementById('modalContent').classList.remove('scale-95');
                document.getElementById('modalContent').classList.add('scale-100');
            });
        }

        function closeModal() {
            itemModal.classList.add('opacity-0');
            document.getElementById('modalContent').classList.add('scale-95');
            document.getElementById('modalContent').classList.remove('scale-100');
            setTimeout(() => itemModal.classList.add('hidden'), 300);
        }

        itemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('itemId').value;
            const name = document.getElementById('itemName').value;
            const username = document.getElementById('itemUsername').value;
            const password = document.getElementById('itemPassword').value;
            const url = document.getElementById('itemUrl').value;

            if (!id) {
                // Create
                const newItem = {
                    id: crypto.randomUUID(),
                    name,
                    username,
                    password,
                    url,
                    created: Date.now()
                };
                vaultData.push(newItem);
                showToast('Password saved!', 'success');
            } else {
                // Update
                const index = vaultData.findIndex(i => i.id === id);
                if (index !== -1) {
                    vaultData[index] = { ...vaultData[index], name, username, password, url };
                    showToast('Password updated!', 'success');
                }
            }

            await saveVault();
            renderVault();
            closeModal();
        });

        function editItem(id) {
            openModal(id);
        }

        async function deleteItem(id) {
            if (confirm('Delete this password?')) {
                vaultData = vaultData.filter(i => i.id !== id);
                await saveVault();
                renderVault();
                showToast('Password deleted.', 'info');
            }
        }

        // Generator Logic
        const passLength = document.getElementById('passLength');
        const lengthValue = document.getElementById('lengthValue');
        const incUppercase = document.getElementById('incUppercase');
        const incLowercase = document.getElementById('incLowercase');
        const incNumbers = document.getElementById('incNumbers');
        const incSymbols = document.getElementById('incSymbols');

        function generatePassword() {
            const length = parseInt(passLength.value);
            lengthValue.textContent = length;

            const upper = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            const lower = "abcdefghijklmnopqrstuvwxyz";
            const numbers = "0123456789";
            const symbols = "!@#$%^&*()_+~`|}{[]:;?><,./-=";

            let chars = "";
            if (incUppercase.checked) chars += upper;
            if (incLowercase.checked) chars += lower;
            if (incNumbers.checked) chars += numbers;
            if (incSymbols.checked) chars += symbols;

            if (chars === "") {
                incLowercase.checked = true;
                chars = lower;
            }

            let password = "";
            const array = new Uint32Array(length);
            window.crypto.getRandomValues(array);
            for (let i = 0; i < length; i++) {
                password += chars[array[i] % chars.length];
            }

            document.getElementById('generatedPassword').value = password;
            evaluateStrength(password);
        }

        [passLength, incUppercase, incLowercase, incNumbers, incSymbols].forEach(el => {
            el.addEventListener('input', generatePassword);
        });

        function fillRandomPass() {
            // Helper for modal
            const length = 16;
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*";
            let password = "";
            const array = new Uint32Array(length);
            window.crypto.getRandomValues(array);
            for (let i = 0; i < length; i++) {
                password += chars[array[i] % chars.length];
            }
            document.getElementById('itemPassword').value = password;
        }

        function evaluateStrength(password) {
            let strength = 0;
            if (password.length > 8) strength++;
            if (password.length > 12) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;

            const bars = document.getElementById('strengthBar').children;
            const text = document.getElementById('strengthText');

            // Reset opacity
            for (let bar of bars) bar.style.opacity = '0.2';

            if (strength <= 2) {
                bars[0].style.opacity = '1';
                text.textContent = 'Weak';
                text.className = 'text-center text-sm mt-2 font-medium text-red-500';
            } else if (strength <= 4) {
                bars[0].style.opacity = '1';
                bars[1].style.opacity = '1';
                bars[2].style.opacity = '1';
                text.textContent = 'Good';
                text.className = 'text-center text-sm mt-2 font-medium text-blue-500';
            } else {
                for (let bar of bars) bar.style.opacity = '1';
                text.textContent = 'Strong';
                text.className = 'text-center text-sm mt-2 font-medium text-emerald-500';
            }
        }

        // Utilities
        function toggleInputVisibility(id) {
            const input = document.getElementById(id);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function toggleCardPassword(id) {
            const input = document.getElementById(`pass-${id}`);
            const icon = document.getElementById(`eye-${id}`);
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                showToast('Copied to clipboard!', 'success');
            } catch (err) {
                showToast('Failed to copy', 'error');
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');

            let bgClass = type === 'success' ? 'bg-emerald-600' : (type === 'error' ? 'bg-red-600' : 'bg-slate-700');
            let iconClass = type === 'success' ? 'fa-check-circle' : (type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle');

            toast.className = `${bgClass} text-white px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 toast transform transition-all duration-300`;
            toast.innerHTML = `
                <i class="fa-solid ${iconClass}"></i>
                <span class="font-medium text-sm">${message}</span>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('hiding');
                toast.addEventListener('animationend', () => toast.remove());
            }, 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function escapeJs(text) {
            if (!text) return '';
            return text.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
        }

        // Import/Export
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(vaultData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "securepass_vault.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function (e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (Array.isArray(imported)) {
                        vaultData = imported;
                        await saveVault();
                        renderVault();
                        showToast('Vault imported successfully!', 'success');
                    } else {
                        throw new Error('Invalid format');
                    }
                } catch (err) {
                    showToast('Invalid JSON file', 'error');
                }
            };
            reader.readAsText(file);
            input.value = ''; // Reset input
        }

    </script>
</body>

</html>