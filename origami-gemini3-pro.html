<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Origami Master - Interactive Guide</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        .paper-transition {
            transition: all 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .fade-enter {
            opacity: 0;
            transform: scale(0.95);
        }

        .fade-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.3s, transform 0.3s;
        }

        /* Dashed line animation for creases */
        .crease-line {
            stroke-dasharray: 4 2;
        }

        /* Arrow bounce */
        .arrow-anim {
            animation: arrow-bounce 1.5s infinite;
            transform-origin: center;
        }

        @keyframes arrow-bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-3px);
            }
        }

        /* Paper texture overlay effect */
        .paper-texture {
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
        }
    </style>
</head>

<body class="bg-stone-50 h-screen flex flex-col font-sans text-stone-800 overflow-hidden">
    <!-- Header -->
    <header class="bg-indigo-600 text-white p-4 shadow-md flex justify-between items-center z-20">
        <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path
                    d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                </path>
                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                <line x1="12" y1="22.08" x2="12" y2="12"></line>
            </svg>
            <h1 class="text-xl font-bold tracking-wider">FOLD<span class="font-light opacity-80">MASTER</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <label for="modelSelect" class="text-sm font-medium opacity-90 hidden sm:block">Select Model:</label>
            <select id="modelSelect"
                class="bg-indigo-700 text-white border border-indigo-500 rounded px-3 py-1 outline-none focus:ring-2 focus:ring-indigo-300 text-sm">
                <!-- Options populated by JS -->
            </select>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">

        <!-- Left Panel: Instructions & Info -->
        <aside
            class="w-full md:w-80 bg-white border-r border-stone-200 z-10 flex flex-col shadow-sm h-1/3 md:h-full overflow-y-auto">

            <div class="p-6 flex-1 flex flex-col">
                <div class="flex justify-between items-end mb-4">
                    <h2 id="modelName" class="text-2xl font-bold text-indigo-900 leading-none">Paper Plane</h2>
                    <span id="stepCounter"
                        class="text-xs font-bold bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full">1 / 10</span>
                </div>

                <!-- Progress Bar -->
                <div class="w-full bg-stone-100 rounded-full h-1.5 mb-6 overflow-hidden">
                    <div id="progressBar" class="bg-indigo-500 h-full rounded-full transition-all duration-300"
                        style="width: 0%"></div>
                </div>

                <!-- Instructions -->
                <div class="mb-8">
                    <h3 class="text-xs font-bold text-stone-400 uppercase tracking-wide mb-2">Step Instruction</h3>
                    <p id="instructionText" class="text-lg text-stone-700 font-medium leading-relaxed">Prepare a square
                        piece of paper.</p>
                </div>

                <!-- Paper Customization -->
                <div class="mt-auto pt-6 border-t border-stone-100">
                    <h3 class="text-xs font-bold text-stone-400 uppercase tracking-wide mb-3">Paper Color</h3>
                    <div class="flex flex-wrap gap-3">
                        <button
                            class="w-8 h-8 rounded-full bg-white border border-stone-200 shadow-sm hover:scale-110 transition ring-2 ring-transparent focus:ring-indigo-400"
                            onclick="app.setPaperColor('#ffffff')"></button>
                        <button
                            class="w-8 h-8 rounded-full bg-blue-400 border border-blue-500 shadow-sm hover:scale-110 transition ring-2 ring-transparent focus:ring-indigo-400"
                            onclick="app.setPaperColor('#60a5fa')"></button>
                        <button
                            class="w-8 h-8 rounded-full bg-red-400 border border-red-500 shadow-sm hover:scale-110 transition ring-2 ring-transparent focus:ring-indigo-400"
                            onclick="app.setPaperColor('#f87171')"></button>
                        <button
                            class="w-8 h-8 rounded-full bg-green-400 border border-green-500 shadow-sm hover:scale-110 transition ring-2 ring-transparent focus:ring-indigo-400"
                            onclick="app.setPaperColor('#4ade80')"></button>
                        <button
                            class="w-8 h-8 rounded-full bg-yellow-300 border border-yellow-400 shadow-sm hover:scale-110 transition ring-2 ring-transparent focus:ring-indigo-400"
                            onclick="app.setPaperColor('#fde047')"></button>
                        <button
                            class="w-8 h-8 rounded-full bg-purple-400 border border-purple-500 shadow-sm hover:scale-110 transition ring-2 ring-transparent focus:ring-indigo-400"
                            onclick="app.setPaperColor('#c084fc')"></button>
                    </div>
                </div>
            </div>

            <!-- Mini CP View -->
            <div class="bg-stone-50 p-6 border-t border-stone-200 hidden md:block">
                <h3 class="text-xs font-bold text-stone-400 uppercase tracking-wide mb-3 flex justify-between">
                    Crease Pattern
                    <span class="text-[10px] text-stone-400 font-normal normal-case">Reference</span>
                </h3>
                <div
                    class="aspect-square w-full max-w-[140px] mx-auto bg-white shadow-inner border border-stone-200 p-2 relative">
                    <svg id="cpSvg" viewBox="0 0 100 100" class="w-full h-full opacity-60">
                        <!-- CP lines -->
                    </svg>
                </div>
            </div>
        </aside>

        <!-- Center: Visualization Stage -->
        <section class="flex-1 bg-stone-100 relative flex flex-col paper-texture">

            <!-- SVG Canvas -->
            <div class="flex-1 flex items-center justify-center p-4 md:p-12 overflow-hidden">
                <div id="canvasContainer"
                    class="relative w-full h-full max-w-3xl max-h-[80vh] flex items-center justify-center">
                    <svg id="mainSvg" viewBox="0 0 120 120"
                        class="w-full h-full drop-shadow-2xl transition-all duration-500">
                        <defs>
                            <filter id="paperShadow" x="-20%" y="-20%" width="140%" height="140%">
                                <feDropShadow dx="1" dy="2" stdDeviation="1" flood-color="#000" flood-opacity="0.2" />
                            </filter>
                        </defs>
                        <!-- Dynamic Paper Content -->
                        <g id="paperGroup" transform="translate(10, 10)">
                            <!-- Polygons for paper parts -->
                        </g>
                        <!-- Dynamic Annotations -->
                        <g id="annotationGroup" transform="translate(10, 10)">
                            <!-- Arrows and lines -->
                        </g>
                    </svg>
                </div>
            </div>

            <!-- Playback Controls -->
            <div
                class="bg-white/90 backdrop-blur border-t border-stone-200 p-4 md:absolute md:bottom-8 md:left-1/2 md:transform md:-translate-x-1/2 md:rounded-full md:shadow-xl md:border md:px-8 md:py-3 z-20 w-full md:w-auto">
                <div class="flex items-center justify-center gap-6">
                    <button id="prevBtn"
                        class="group p-2 rounded-full hover:bg-stone-100 text-stone-500 hover:text-indigo-600 transition disabled:opacity-30 disabled:cursor-not-allowed"
                        title="Previous Step">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                            class="group-hover:-translate-x-1 transition-transform">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                    </button>

                    <button id="playBtn"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-full p-4 shadow-lg shadow-indigo-300 hover:shadow-indigo-400 hover:scale-105 transition active:scale-95"
                        title="Play Animation">
                        <svg id="playIcon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"
                            fill="currentColor" stroke="none">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        <svg id="pauseIcon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="28" height="28"
                            viewBox="0 0 24 24" fill="currentColor" stroke="none">
                            <rect x="6" y="4" width="4" height="16"></rect>
                            <rect x="14" y="4" width="4" height="16"></rect>
                        </svg>
                    </button>

                    <button id="nextBtn"
                        class="group p-2 rounded-full hover:bg-stone-100 text-stone-500 hover:text-indigo-600 transition disabled:opacity-30 disabled:cursor-not-allowed"
                        title="Next Step">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                            class="group-hover:translate-x-1 transition-transform">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>
                </div>
            </div>
        </section>
    </main>

    <script>
        // --- DATA ---

        const models = {
            "plane": {
                name: "Classic Plane",
                steps: [
                    {
                        desc: "Start with a square piece of paper.",
                        shapes: [
                            { points: "10,10 90,10 90,90 10,90", color: "front" }
                        ],
                        annotations: []
                    },
                    {
                        desc: "Fold in half vertically to make a crease.",
                        shapes: [
                            { points: "10,10 90,10 90,90 10,90", color: "front" }
                        ],
                        annotations: [
                            { type: "line", points: "50,10 50,90", style: "valley" },
                            { type: "arrow", points: "80,50 20,50", style: "fold-unfold" }
                        ]
                    },
                    {
                        desc: "Fold the top corners to the center line.",
                        shapes: [
                            { points: "10,10 50,10 50,50 10,50", color: "front", transform: "skew" } // Conceptual
                        ],
                        // Instead of 3D logic, we just draw the result state for simplicity in this demo,
                        // or better: draw the PRE-fold state with indicators
                        renderType: "pre", // We will render the state BEFORE the action, with arrows
                        baseShapes: [
                            { points: "10,10 90,10 90,90 10,90", color: "front" }
                        ],
                        annotations: [
                            { type: "line", points: "50,10 50,90", style: "crease" },
                            { type: "line", points: "10,10 50,50", style: "valley" }, // Fold line left
                            { type: "line", points: "90,10 50,50", style: "valley" }, // Fold line right
                            { type: "arrow", points: "10,10 50,40" },
                            { type: "arrow", points: "90,10 50,40" }
                        ]
                    },
                    {
                        desc: "The paper should look like a house shape.",
                        renderType: "post",
                        baseShapes: [
                            { points: "10,50 50,10 90,50 90,90 10,90", color: "front" },
                            { points: "10,50 50,10 50,50", color: "back" }, // folded flap left
                            { points: "90,50 50,10 50,50", color: "back" }  // folded flap right
                        ],
                        annotations: []
                    },
                    {
                        desc: "Fold the angled edges to the center line again.",
                        baseShapes: [
                            { points: "10,50 50,10 90,50 90,90 10,90", color: "front" },
                            { points: "10,50 50,10 50,50", color: "back" },
                            { points: "90,50 50,10 50,50", color: "back" }
                        ],
                        annotations: [
                            { type: "line", points: "50,10 50,90", style: "crease" },
                            { type: "line", points: "50,10 25,90", style: "valley" }, // Approx fold line
                            { type: "line", points: "50,10 75,90", style: "valley" },
                            { type: "arrow", points: "10,50 45,60" },
                            { type: "arrow", points: "90,50 55,60" }
                        ]
                    },
                    {
                        desc: "Now it looks sharper.",
                        baseShapes: [
                            { points: "25,90 50,10 75,90", color: "back" }, // Main body visible part
                            { points: "25,90 50,10 50,90", color: "front-shade" }, // folded flap left
                            { points: "75,90 50,10 50,90", color: "front-shade" }  // folded flap right
                        ],
                        annotations: []
                    },
                    {
                        desc: "Fold in half along the center line.",
                        baseShapes: [
                            { points: "25,90 50,10 75,90", color: "back" },
                            { points: "25,90 50,10 50,90", color: "front-shade" },
                            { points: "75,90 50,10 50,90", color: "front-shade" }
                        ],
                        annotations: [
                            { type: "line", points: "50,10 50,90", style: "mountain" },
                            { type: "arrow", points: "70,50 30,50", style: "curved" }
                        ]
                    },
                    {
                        desc: "Fold wings down to create the plane wings.",
                        baseShapes: [
                            // Side view now
                            { points: "10,90 90,90 90,20", color: "front" } // Rotated view approx
                        ],
                        // Switching view for simplicity
                        annotations: [
                            { type: "text", x: 50, y: 50, text: "Rotate view 90Â°" }
                        ]
                    },
                    {
                        desc: "Finished Paper Plane!",
                        baseShapes: [
                            { points: "10,60 90,60 90,40 30,20", color: "front" },
                            { points: "30,60 90,60 90,80 30,100", color: "back", opacity: 0.5 }
                        ],
                        annotations: []
                    }
                ],
                cp: [
                    "50,0 50,100",
                    "0,0 100,100",
                    "100,0 0,100"
                ]
            },
            "cup": {
                name: "Drinking Cup",
                steps: [
                    {
                        desc: "Start with a square paper, color side down.",
                        baseShapes: [{ points: "10,10 90,10 90,90 10,90", color: "back" }],
                        annotations: []
                    },
                    {
                        desc: "Fold diagonally to form a triangle.",
                        baseShapes: [{ points: "10,10 90,10 90,90 10,90", color: "back" }],
                        annotations: [
                            { type: "line", points: "10,90 90,10", style: "valley" },
                            { type: "arrow", points: "15,15 80,80" }
                        ]
                    },
                    {
                        desc: "Triangle formed. Now fold the top corner of the front layer down to the bottom edge.",
                        baseShapes: [
                            { points: "10,90 90,90 90,10", color: "front" }
                        ],
                        annotations: [
                            { type: "line", points: "35,65 90,10", style: "crease" } // Just visual
                        ]
                    },
                    {
                        desc: "Fold the right corner to touch the left edge.",
                        baseShapes: [
                            { points: "10,90 90,90 90,10", color: "front" }
                        ],
                        annotations: [
                            { type: "line", points: "90,90 35,35", style: "valley" }, // Approx line
                            { type: "arrow", points: "90,90 35,40" }
                        ]
                    },
                    {
                        desc: "Fold the left corner to touch the right edge.",
                        baseShapes: [
                            { points: "10,90 60,90 60,60 90,10", color: "front" }, // Base triangle truncated
                            { points: "30,35 60,60 90,90", color: "front" } // The folded flap
                        ],
                        annotations: [
                            { type: "arrow", points: "10,90 60,40" }
                        ]
                    },
                    {
                        desc: "Fold the top triangle down.",
                        baseShapes: [
                            { points: "40,30 60,30 90,90 60,90 30,90 10,90", color: "front" }, // Approx shape
                            // Flaps
                            { points: "10,90 60,40 40,30", color: "front" },
                            { points: "90,90 40,40 60,30", color: "front" }
                        ],
                        annotations: [
                            { type: "arrow", points: "50,10 50,40" }
                        ]
                    },
                    {
                        desc: "Finished Cup!",
                        baseShapes: [
                            { points: "30,90 70,90 90,40 10,40", color: "front" },
                            { points: "10,40 90,40 50,80", color: "front-shade", opacity: 0.5 }
                        ],
                        annotations: []
                    }
                ],
                cp: [
                    "10,90 90,10",
                    "30,30 90,30"
                ]
            },
            "hat": {
                name: "Samurai Helmet",
                steps: [
                    {
                        desc: "Start with square paper.",
                        baseShapes: [{ points: "10,10 90,10 90,90 10,90", color: "front" }],
                        annotations: []
                    },
                    {
                        desc: "Fold in half diagonally.",
                        baseShapes: [{ points: "10,10 90,10 90,90 10,90", color: "front" }],
                        annotations: [
                            { type: "line", points: "10,10 90,90", style: "valley" },
                            { type: "arrow", points: "80,20 20,80" }
                        ]
                    },
                    {
                        desc: "Fold corners up to the top point.",
                        baseShapes: [{ points: "10,10 90,90 10,90", color: "front" }],
                        annotations: [
                            { type: "line", points: "50,50 90,90", style: "valley" },
                            { type: "line", points: "50,50 10,90", style: "valley" },
                            { type: "arrow", points: "90,90 15,15" },
                            { type: "arrow", points: "10,90 15,15" }
                        ]
                    },
                    {
                        desc: "Fold the top flaps upwards.",
                        baseShapes: [{ points: "10,10 50,50 10,90", color: "front" }], // Simplified square shape after fold
                        annotations: [
                            { type: "arrow", points: "30,30 30,10" }
                        ]
                    },
                    {
                        desc: "Finished Helmet.",
                        baseShapes: [
                            { points: "10,90 90,90 50,10", color: "front" },
                            { points: "40,90 50,70 60,90", color: "back" } // Decor
                        ],
                        annotations: []
                    }
                ],
                cp: [
                    "10,10 90,90"
                ]
            }
        };

        // --- APP LOGIC ---

        const app = {
            currentModel: "plane",
            currentStep: 0,
            isPlaying: false,
            playInterval: null,
            paperColor: '#60a5fa',

            init() {
                this.populateModelSelect();
                this.loadModel("plane");
                this.setupEventListeners();
                this.render();
            },

            populateModelSelect() {
                const select = document.getElementById('modelSelect');
                select.innerHTML = '';
                Object.keys(models).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = models[key].name;
                    select.appendChild(option);
                });
            },

            loadModel(modelId) {
                this.currentModel = modelId;
                this.currentStep = 0;
                this.isPlaying = false;
                this.stopPlay();
                document.getElementById('modelName').textContent = models[modelId].name;
                this.render();
            },

            setPaperColor(color) {
                this.paperColor = color;
                this.render();
            },

            setupEventListeners() {
                document.getElementById('modelSelect').addEventListener('change', (e) => this.loadModel(e.target.value));
                document.getElementById('prevBtn').addEventListener('click', () => this.prevStep());
                document.getElementById('nextBtn').addEventListener('click', () => this.nextStep());
                document.getElementById('playBtn').addEventListener('click', () => this.togglePlay());
            },

            prevStep() {
                if (this.currentStep > 0) {
                    this.currentStep--;
                    this.render();
                }
            },

            nextStep() {
                const maxStep = models[this.currentModel].steps.length - 1;
                if (this.currentStep < maxStep) {
                    this.currentStep++;
                    this.render();
                } else if (this.isPlaying) {
                    this.stopPlay();
                }
            },

            togglePlay() {
                if (this.isPlaying) {
                    this.stopPlay();
                } else {
                    this.startPlay();
                }
            },

            startPlay() {
                this.isPlaying = true;
                document.getElementById('playIcon').classList.add('hidden');
                document.getElementById('pauseIcon').classList.remove('hidden');

                // If at end, restart
                const maxStep = models[this.currentModel].steps.length - 1;
                if (this.currentStep === maxStep) {
                    this.currentStep = 0;
                    this.render();
                }

                this.playInterval = setInterval(() => {
                    this.nextStep();
                }, 2000);
            },

            stopPlay() {
                this.isPlaying = false;
                clearInterval(this.playInterval);
                document.getElementById('playIcon').classList.remove('hidden');
                document.getElementById('pauseIcon').classList.add('hidden');
            },

            render() {
                const model = models[this.currentModel];
                const stepData = model.steps[this.currentStep];
                const totalSteps = model.steps.length;

                // Update UI Text
                document.getElementById('stepCounter').textContent = `${this.currentStep + 1} / ${totalSteps}`;
                document.getElementById('instructionText').textContent = stepData.desc;
                document.getElementById('progressBar').style.width = `${((this.currentStep + 1) / totalSteps) * 100}%`;

                // Update Buttons
                document.getElementById('prevBtn').disabled = this.currentStep === 0;
                document.getElementById('nextBtn').disabled = this.currentStep === totalSteps - 1;

                // Check if Play button should be Replay
                const isEnded = this.currentStep === totalSteps - 1;
                if (isEnded && !this.isPlaying) {
                    // Could change icon to replay here if we had one, but keeping play icon is standard
                }

                // Animate Transition
                const svg = document.getElementById('mainSvg');
                svg.style.opacity = '0';
                svg.style.transform = 'scale(0.95)';

                setTimeout(() => {
                    // Render Main SVG content
                    this.renderSvg(stepData);

                    // Fade In
                    svg.style.opacity = '1';
                    svg.style.transform = 'scale(1)';
                }, 200);

                // Render CP
                this.renderCp(model.cp);
            },

            renderSvg(stepData) {
                const paperGroup = document.getElementById('paperGroup');
                const annotationGroup = document.getElementById('annotationGroup');

                paperGroup.innerHTML = '';
                annotationGroup.innerHTML = '';

                // Draw shapes
                if (stepData.baseShapes) {
                    stepData.baseShapes.forEach(shape => {
                        const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                        polygon.setAttribute("points", shape.points);

                        // Color logic
                        let fill = this.paperColor;
                        if (shape.color === 'back') fill = '#e5e7eb'; // white/grey back
                        if (shape.color === 'front-shade') fill = this.shadeColor(this.paperColor, -20);

                        polygon.setAttribute("fill", fill);
                        polygon.setAttribute("stroke", "#4b5563");
                        polygon.setAttribute("stroke-width", "0.5");
                        polygon.setAttribute("filter", "url(#paperShadow)");
                        paperGroup.appendChild(polygon);
                    });
                } else if (stepData.shapes) {
                    stepData.shapes.forEach(shape => {
                        const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                        polygon.setAttribute("points", shape.points);
                        polygon.setAttribute("fill", this.paperColor);
                        polygon.setAttribute("stroke", "#4b5563");
                        polygon.setAttribute("stroke-width", "0.5");
                        polygon.setAttribute("filter", "url(#paperShadow)");
                        paperGroup.appendChild(polygon);
                    });
                }

                // Draw Annotations
                if (stepData.annotations) {
                    stepData.annotations.forEach(note => {
                        if (note.type === 'line') {
                            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                            const [p1, p2] = note.points.split(' ');
                            const [x1, y1] = p1.split(',');
                            const [x2, y2] = p2.split(',');

                            line.setAttribute("x1", x1);
                            line.setAttribute("y1", y1);
                            line.setAttribute("x2", x2);
                            line.setAttribute("y2", y2);
                            line.setAttribute("stroke", note.style === 'mountain' ? '#ef4444' : '#000');
                            line.setAttribute("stroke-width", "1");

                            if (note.style === 'valley' || note.style === 'mountain') {
                                line.setAttribute("stroke-dasharray", "4 2");
                            }
                            annotationGroup.appendChild(line);
                        } else if (note.type === 'arrow') {
                            // Simple line arrow for now
                            const [p1, p2] = note.points.split(' ');
                            const [x1, y1] = p1.split(',');
                            const [x2, y2] = p2.split(',');

                            // Arrow Line
                            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                            line.setAttribute("x1", x1);
                            line.setAttribute("y1", y1);
                            line.setAttribute("x2", x2);
                            line.setAttribute("y2", y2);
                            line.setAttribute("stroke", "#000");
                            line.setAttribute("stroke-width", "1.5");
                            line.setAttribute("marker-end", "url(#arrowhead)");
                            line.classList.add('arrow-anim');
                            annotationGroup.appendChild(line);

                            // Arrowhead def
                            if (!document.getElementById('arrowhead')) {
                                const defs = document.querySelector('defs');
                                const marker = document.createElementNS("http://www.w3.org/2000/svg", "marker");
                                marker.setAttribute("id", "arrowhead");
                                marker.setAttribute("markerWidth", "10");
                                marker.setAttribute("markerHeight", "7");
                                marker.setAttribute("refX", "9");
                                marker.setAttribute("refY", "3.5");
                                marker.setAttribute("orient", "auto");
                                const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                                polygon.setAttribute("points", "0 0, 10 3.5, 0 7");
                                polygon.setAttribute("fill", "#000");
                                marker.appendChild(polygon);
                                defs.appendChild(marker);
                            }
                        } else if (note.type === 'text') {
                            const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                            text.setAttribute("x", note.x);
                            text.setAttribute("y", note.y);
                            text.textContent = note.text;
                            text.setAttribute("text-anchor", "middle");
                            text.setAttribute("fill", "#666");
                            text.setAttribute("font-size", "5");
                            annotationGroup.appendChild(text);
                        }
                    });
                }
            },

            renderCp(cpLines) {
                const cpSvg = document.getElementById('cpSvg');
                cpSvg.innerHTML = '';
                if (!cpLines) return;

                cpLines.forEach(lineStr => {
                    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    const [p1, p2] = lineStr.split(' ');
                    const [x1, y1] = p1.split(',');
                    const [x2, y2] = p2.split(',');

                    line.setAttribute("x1", x1);
                    line.setAttribute("y1", y1);
                    line.setAttribute("x2", x2);
                    line.setAttribute("y2", y2);
                    line.setAttribute("stroke", "#9ca3af");
                    line.setAttribute("stroke-width", "0.5");
                    cpSvg.appendChild(line);
                });
            },

            shadeColor(color, percent) {
                // Normalize 3-digit hex to 6-digit
                if (color.length === 4) {
                    color = '#' + color[1] + color[1] + color[2] + color[2] + color[3] + color[3];
                }

                var R = parseInt(color.substring(1, 3), 16);
                var G = parseInt(color.substring(3, 5), 16);
                var B = parseInt(color.substring(5, 7), 16);

                R = parseInt(R * (100 + percent) / 100);
                G = parseInt(G * (100 + percent) / 100);
                B = parseInt(B * (100 + percent) / 100);

                R = (R < 255) ? R : 255;
                G = (G < 255) ? G : 255;
                B = (B < 255) ? B : 255;

                // Prevent negative values
                R = (R > 0) ? R : 0;
                G = (G > 0) ? G : 0;
                B = (B > 0) ? B : 0;

                var RR = ((R.toString(16).length == 1) ? "0" + R.toString(16) : R.toString(16));
                var GG = ((G.toString(16).length == 1) ? "0" + G.toString(16) : G.toString(16));
                var BB = ((B.toString(16).length == 1) ? "0" + B.toString(16) : B.toString(16));

                return "#" + RR + GG + BB;
            }
        };

        app.init();

    </script>
</body>

</html>