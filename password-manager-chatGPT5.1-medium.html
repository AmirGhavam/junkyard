<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SecureVault Password Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        /* Custom scrollbar for better UX */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background-color: rgba(148, 163, 184, 0.7);
            border-radius: 9999px;
        }
    </style>
</head>

<body class="h-full bg-slate-950 text-slate-100 flex flex-col">
    <div id="appRoot" class="flex flex-col min-h-full">
        <!-- Header -->
        <header class="border-b border-slate-800 bg-slate-950/80 backdrop-blur sticky top-0 z-20">
            <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
                <div class="flex items-center gap-2">
                    <div
                        class="h-8 w-8 rounded-lg bg-gradient-to-br from-indigo-500 to-cyan-400 flex items-center justify-center text-xs font-bold tracking-tight shadow-lg shadow-indigo-500/40">
                        SV
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold tracking-tight">SecureVault</h1>
                        <p class="text-xs text-slate-400">Local-first encrypted password manager</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 text-xs">
                    <button id="exportBtn"
                        class="px-2.5 py-1 rounded-md border border-slate-700/80 bg-slate-900/80 hover:bg-slate-800 text-slate-100 disabled:opacity-40 disabled:cursor-not-allowed hidden">
                        Export
                    </button>
                    <button id="importBtn"
                        class="px-2.5 py-1 rounded-md border border-slate-700/80 bg-slate-900/80 hover:bg-slate-800 text-slate-100 disabled:opacity-40 disabled:cursor-not-allowed hidden">
                        Import
                    </button>
                    <button id="lockBtn"
                        class="px-2.5 py-1 rounded-md border border-rose-600/60 bg-rose-600/10 hover:bg-rose-600/20 text-rose-200 disabled:opacity-40 disabled:cursor-not-allowed hidden">
                        Lock
                    </button>
                    <button id="themeToggle"
                        class="ml-1 p-1.5 rounded-full border border-slate-700/80 bg-slate-900/80 hover:bg-slate-800"
                        aria-label="Toggle theme">
                        <span id="themeIcon" class="block text-slate-200 text-xs">‚òæ</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Locked / Setup View -->
        <main class="flex-1 flex items-center justify-center px-4 py-6" id="lockedView">
            <div
                class="w-full max-w-md bg-slate-900/80 border border-slate-800 rounded-2xl shadow-xl shadow-black/60 p-6 space-y-5">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-lg font-semibold tracking-tight" id="lockedTitle">Create master password</h2>
                    <span
                        class="inline-flex items-center gap-1 text-[10px] uppercase tracking-[0.18em] text-emerald-400 bg-emerald-500/10 border border-emerald-500/40 rounded-full px-2 py-0.5">
                        <span class="h-1.5 w-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                        Local Only
                    </span>
                </div>
                <p class="text-xs text-slate-400" id="lockedSubtitle">
                    Your data is encrypted locally using your master password. It cannot be recovered if you forget it.
                </p>

                <!-- Tabs -->
                <div class="flex text-xs bg-slate-800/60 rounded-lg p-1">
                    <button id="setupTab" class="flex-1 py-1.5 rounded-md bg-slate-900 text-slate-100 font-medium">Set
                        master password</button>
                    <button id="unlockTab" class="flex-1 py-1.5 rounded-md text-slate-400 hover:text-slate-100">Unlock
                        vault</button>
                </div>

                <!-- Setup Form -->
                <form id="setupForm" class="space-y-4 mt-1">
                    <div class="space-y-1.5">
                        <label class="text-xs font-medium text-slate-200">Master password</label>
                        <input id="setupMaster" type="password"
                            class="w-full px-3 py-2 text-sm rounded-lg bg-slate-950 border border-slate-700 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500"
                            autocomplete="new-password" required />
                        <p class="text-[11px] text-slate-400">Use a long, unique passphrase (e.g., four or more random
                            words).</p>
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-xs font-medium text-slate-200">Confirm master password</label>
                        <input id="setupMasterConfirm" type="password"
                            class="w-full px-3 py-2 text-sm rounded-lg bg-slate-950 border border-slate-700 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500"
                            autocomplete="new-password" required />
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-xs font-medium text-slate-200 flex items-center gap-1">Password hint <span
                                class="text-[10px] text-slate-500 font-normal">(optional, stored
                                unencrypted)</span></label>
                        <input id="setupHint" type="text"
                            class="w-full px-3 py-2 text-sm rounded-lg bg-slate-950 border border-slate-700 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500"
                            maxlength="120" />
                    </div>
                    <p id="setupError" class="text-xs text-rose-400 min-h-[1.25rem]"></p>
                    <button type="submit"
                        class="w-full flex items-center justify-center gap-1.5 py-2.5 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-sm font-medium text-white shadow-lg shadow-indigo-600/40">
                        Initialize vault
                    </button>
                </form>

                <!-- Unlock Form -->
                <form id="unlockForm" class="space-y-4 mt-1 hidden">
                    <div class="space-y-1.5">
                        <label class="text-xs font-medium text-slate-200 flex items-center justify-between">
                            <span>Master password</span>
                            <span id="hintText" class="text-[10px] text-slate-500"></span>
                        </label>
                        <input id="unlockMaster" type="password"
                            class="w-full px-3 py-2 text-sm rounded-lg bg-slate-950 border border-slate-700 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500"
                            autocomplete="current-password" required />
                    </div>
                    <p id="unlockError" class="text-xs text-rose-400 min-h-[1.25rem]"></p>
                    <button type="submit"
                        class="w-full flex items-center justify-center gap-1.5 py-2.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-sm font-medium text-white shadow-lg shadow-emerald-600/40">
                        Unlock vault
                    </button>
                    <p class="text-[11px] text-slate-500 text-center">
                        All data is stored in your browser's local storage and never leaves your device.
                    </p>
                </form>
            </div>
        </main>

        <!-- Main App View -->
        <main id="appView" class="flex-1 hidden">
            <div class="max-w-6xl mx-auto w-full px-4 py-4 flex flex-col gap-4 lg:flex-row lg:h-[calc(100vh-4.5rem)]">
                <!-- Sidebar: Entries list -->
                <section
                    class="w-full lg:w-72 flex flex-col bg-slate-900/80 border border-slate-800 rounded-2xl shadow-lg shadow-black/60 overflow-hidden">
                    <div class="p-3 border-b border-slate-800 space-y-2">
                        <div class="flex items-center gap-2">
                            <div class="relative flex-1">
                                <span
                                    class="pointer-events-none absolute inset-y-0 left-2 flex items-center text-slate-500 text-xs">üîç</span>
                                <input id="searchInput" type="text" placeholder="Search entries"
                                    class="w-full pl-6 pr-2 py-1.5 text-xs rounded-md bg-slate-950 border border-slate-700 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" />
                            </div>
                            <button id="addEntryBtn"
                                class="px-2 py-1 text-xs rounded-md bg-indigo-600 hover:bg-indigo-500 text-white font-medium">
                                New
                            </button>
                        </div>
                        <div class="flex items-center justify-between gap-2 text-[11px] text-slate-400">
                            <div class="flex items-center gap-1">
                                <span class="h-1.5 w-1.5 rounded-full bg-emerald-400"></span>
                                <span id="entryCount">0 entries</span>
                            </div>
                            <select id="sortSelect"
                                class="bg-slate-900 border border-slate-700 rounded-md px-1.5 py-0.5 text-[11px] focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                <option value="recent">Most recent</option>
                                <option value="name">Name A‚ÜíZ</option>
                                <option value="fav">Favorites first</option>
                            </select>
                        </div>
                    </div>
                    <div id="entryList" class="flex-1 overflow-y-auto text-xs divide-y divide-slate-800/80">
                        <!-- Entries rendered here -->
                    </div>
                </section>

                <!-- Detail / Form -->
                <section
                    class="flex-1 bg-slate-900/80 border border-slate-800 rounded-2xl shadow-lg shadow-black/60 flex flex-col overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-800 flex items-center justify-between gap-2">
                        <div>
                            <h2 class="text-sm font-semibold tracking-tight" id="detailTitle">No entry selected</h2>
                            <p class="text-[11px] text-slate-400" id="detailSubtitle">Create a new entry or select one
                                from the list.</p>
                        </div>
                        <div class="flex items-center gap-1.5 text-[11px] text-slate-400">
                            <span>Auto-lock</span>
                            <select id="autoLockSelect"
                                class="bg-slate-900 border border-slate-700 rounded-md px-1.5 py-0.5 focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                <option value="5">5 min</option>
                                <option value="10" selected>10 min</option>
                                <option value="30">30 min</option>
                                <option value="0">Off</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4">
                        <form id="entryForm" class="space-y-4 text-sm">
                            <input type="hidden" id="entryId" />
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="space-y-1.5">
                                    <label class="text-xs font-medium text-slate-200">Name / Label</label>
                                    <input id="entryName" type="text"
                                        class="w-full px-3 py-1.5 text-sm rounded-lg bg-slate-950 border border-slate-700 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500"
                                        placeholder="e.g., Email - Personal" />
                                </div>
                                <div class="space-y-1.5">
                                    <label class="text-xs font-medium text-slate-200">Website / App</label>
                                    <input id="entrySite" type="text"
                                        class="w-full px-3 py-1.5 text-sm rounded-lg bg-slate-950 border border-slate-700 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500"
                                        placeholder="e.g., gmail.com" />
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="space-y-1.5">
                                    <label class="text-xs font-medium text-slate-200">Username</label>
                                    <div class="flex gap-1">
                                        <input id="entryUsername" type="text"
                                            class="flex-1 px-3 py-1.5 text-sm rounded-lg bg-slate-950 border border-slate-700 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" />
                                        <button type="button" data-copy-target="entryUsername"
                                            class="copyBtn px-2.5 py-1.5 text-[11px] rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700/80">Copy</button>
                                    </div>
                                </div>
                                <div class="space-y-1.5">
                                    <label class="text-xs font-medium text-slate-200">Email (optional)</label>
                                    <input id="entryEmail" type="email"
                                        class="w-full px-3 py-1.5 text-sm rounded-lg bg-slate-950 border border-slate-700 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" />
                                </div>
                            </div>

                            <div class="space-y-1.5">
                                <label class="text-xs font-medium text-slate-200 flex items-center justify-between">
                                    <span>Password</span>
                                    <button type="button" id="openGeneratorBtn"
                                        class="text-[11px] text-indigo-400 hover:text-indigo-300 flex items-center gap-1">
                                        Generate secure password
                                    </button>
                                </label>
                                <div class="flex gap-1">
                                    <div class="relative flex-1">
                                        <input id="entryPassword" type="password"
                                            class="w-full pr-16 pl-3 py-1.5 text-sm rounded-lg bg-slate-950 border border-slate-700 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500"
                                            autocomplete="new-password" />
                                        <div class="absolute inset-y-0 right-1 flex items-center gap-1">
                                            <button type="button" id="togglePassword"
                                                class="text-[11px] text-slate-400 hover:text-slate-200 px-1.5 py-0.5 rounded-md bg-slate-900/80">Show</button>
                                            <button type="button" data-copy-target="entryPassword"
                                                class="copyBtn text-[11px] px-1.5 py-0.5 rounded-md bg-slate-800 hover:bg-slate-700 border border-slate-700/80">Copy</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-1 space-y-1">
                                    <div class="w-full h-1.5 rounded-full bg-slate-800 overflow-hidden">
                                        <div id="strengthBar" class="h-full w-0 rounded-full bg-red-500 transition-all">
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between text-[11px] text-slate-400">
                                        <span id="strengthLabel">Strength: n/a</span>
                                        <span id="strengthDetail"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-1.5">
                                <label class="text-xs font-medium text-slate-200">URL (optional)</label>
                                <div class="flex gap-1">
                                    <input id="entryUrl" type="url"
                                        class="flex-1 px-3 py-1.5 text-sm rounded-lg bg-slate-950 border border-slate-700 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500"
                                        placeholder="https://" />
                                    <button type="button" data-copy-target="entryUrl"
                                        class="copyBtn px-2.5 py-1.5 text-[11px] rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700/80">Copy</button>
                                </div>
                            </div>

                            <div class="space-y-1.5">
                                <label class="text-xs font-medium text-slate-200">Tags</label>
                                <input id="entryTags" type="text"
                                    class="w-full px-3 py-1.5 text-sm rounded-lg bg-slate-950 border border-slate-700 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500"
                                    placeholder="e.g., work, banking, shared" />
                                <p class="text-[11px] text-slate-500">Separate with commas. Used for filtering and
                                    organization.</p>
                            </div>

                            <div class="space-y-1.5">
                                <label class="text-xs font-medium text-slate-200">Notes</label>
                                <textarea id="entryNotes" rows="4"
                                    class="w-full px-3 py-1.5 text-sm rounded-lg bg-slate-950 border border-slate-700 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500"
                                    placeholder="Additional details, backup codes, security questions (avoid real answers)."></textarea>
                            </div>

                            <div
                                class="flex flex-wrap items-center justify-between gap-2 pt-2 border-t border-slate-800/80">
                                <div class="flex flex-wrap items-center gap-2 text-[11px] text-slate-500">
                                    <span id="metaCreated">Created: ‚Äî</span>
                                    <span class="text-slate-700">‚Ä¢</span>
                                    <span id="metaUpdated">Updated: ‚Äî</span>
                                    <span class="text-slate-700">‚Ä¢</span>
                                    <button type="button" id="favoriteToggle"
                                        class="px-2 py-0.5 rounded-full border border-amber-500/40 bg-amber-500/10 text-amber-300 hidden">‚òÖ
                                        Favorite</button>
                                </div>
                                <div class="flex flex-wrap items-center gap-2 text-xs">
                                    <button type="button" id="newEntryBtn"
                                        class="px-2.5 py-1.5 rounded-lg border border-slate-700 bg-slate-900 hover:bg-slate-800 text-slate-100">New</button>
                                    <button type="button" id="duplicateEntryBtn"
                                        class="px-2.5 py-1.5 rounded-lg border border-slate-700 bg-slate-900 hover:bg-slate-800 text-slate-100 disabled:opacity-40 disabled:cursor-not-allowed">Duplicate</button>
                                    <button type="button" id="deleteEntryBtn"
                                        class="px-2.5 py-1.5 rounded-lg border border-rose-700/70 bg-rose-700/10 hover:bg-rose-700/20 text-rose-200 disabled:opacity-40 disabled:cursor-not-allowed">Delete</button>
                                    <button type="submit"
                                        class="px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white font-medium shadow-md shadow-emerald-600/40">Save</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Hidden file input for import -->
    <input id="importFileInput" type="file" accept="application/json" class="hidden" />

    <!-- Password Generator Modal -->
    <div id="generatorModal"
        class="fixed inset-0 z-40 bg-black/70 backdrop-blur-sm hidden items-center justify-center px-4">
        <div
            class="w-full max-w-md bg-slate-900 border border-slate-800 rounded-2xl shadow-2xl shadow-black/70 p-5 space-y-4">
            <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold tracking-tight">Password generator</h3>
                <button id="closeGeneratorBtn" class="text-slate-400 hover:text-slate-100 text-xs">‚úï</button>
            </div>
            <div class="space-y-3 text-sm">
                <div class="space-y-1.5">
                    <label class="text-xs font-medium text-slate-200">Generated password</label>
                    <div class="flex gap-1">
                        <input id="genOutput" type="text" readonly
                            class="flex-1 px-3 py-1.5 text-sm rounded-lg bg-slate-950 border border-slate-700 text-slate-100" />
                        <button type="button" id="genCopyBtn"
                            class="px-2.5 py-1.5 text-[11px] rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700/80">Copy</button>
                    </div>
                </div>
                <div class="grid grid-cols-[1fr_auto] gap-2 items-center">
                    <div class="space-y-1">
                        <label class="text-xs font-medium text-slate-200">Length</label>
                        <input id="genLength" type="range" min="8" max="64" value="20" class="w-full" />
                    </div>
                    <div class="pt-4 text-xs text-slate-300 text-right">
                        <span id="genLengthValue">20</span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <label class="flex items-center gap-2">
                        <input id="genLower" type="checkbox" class="rounded border-slate-700 bg-slate-950" checked />
                        <span>Lowercase (a-z)</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input id="genUpper" type="checkbox" class="rounded border-slate-700 bg-slate-950" checked />
                        <span>Uppercase (A-Z)</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input id="genNumbers" type="checkbox" class="rounded border-slate-700 bg-slate-950" checked />
                        <span>Numbers (0-9)</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input id="genSymbols" type="checkbox" class="rounded border-slate-700 bg-slate-950" />
                        <span>Symbols (!@#$...)</span>
                    </label>
                    <label class="flex items-center gap-2 col-span-2">
                        <input id="genNoAmbiguous" type="checkbox" class="rounded border-slate-700 bg-slate-950"
                            checked />
                        <span>Avoid ambiguous (0/O, 1/l, etc.)</span>
                    </label>
                </div>
                <p id="genError" class="text-[11px] text-rose-400 min-h-[1.25rem]"></p>
            </div>
            <div class="flex items-center justify-between gap-2 pt-1 text-xs">
                <button id="genUseBtn"
                    class="px-2.5 py-1.5 rounded-lg border border-emerald-600/80 bg-emerald-600/10 hover:bg-emerald-600/20 text-emerald-200 font-medium">Use
                    for current entry</button>
                <button id="genNewBtn"
                    class="ml-auto px-2.5 py-1.5 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white font-medium">Generate</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"
        class="fixed bottom-4 right-4 z-50 hidden px-3 py-2 rounded-lg text-xs bg-slate-900 border border-slate-700 text-slate-100 shadow-lg shadow-black/60 max-w-xs">
    </div>

    <script>
        // ----------------------------
        // Utility functions
        // ----------------------------

        const textEncoder = new TextEncoder();
        const textDecoder = new TextDecoder();

        function bufToBase64(buf) {
            const bytes = new Uint8Array(buf);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        function base64ToBuf(base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function randomBytes(length) {
            const arr = new Uint8Array(length);
            crypto.getRandomValues(arr);
            return arr;
        }

        function formatDateTime(iso) {
            if (!iso) return '‚Äî';
            try {
                return new Date(iso).toLocaleString();
            } catch {
                return '‚Äî';
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.textContent = message;
            toast.classList.remove('hidden');
            toast.classList.remove('border-emerald-500/80', 'text-emerald-100', 'border-rose-500/80', 'text-rose-100');
            if (type === 'success') {
                toast.classList.add('border-emerald-500/80', 'text-emerald-100');
            } else if (type === 'error') {
                toast.classList.add('border-rose-500/80', 'text-rose-100');
            }
            clearTimeout(showToast._timer);
            showToast._timer = setTimeout(() => {
                toast.classList.add('hidden');
            }, 2600);
        }

        function updateActivity() {
            window._lastActivity = Date.now();
        }

        // ----------------------------
        // Crypto helpers (PBKDF2 + AES-GCM)
        // ----------------------------

        async function deriveKey(password, saltB64) {
            const salt = saltB64 ? base64ToBuf(saltB64) : randomBytes(16).buffer;
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                textEncoder.encode(password),
                { name: 'PBKDF2' },
                false,
                ['deriveKey']
            );
            const key = await crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt,
                    iterations: 250000,
                    hash: 'SHA-256',
                },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt', 'decrypt']
            );
            return { key, saltB64: bufToBase64(salt) };
        }

        async function encryptJson(obj, key) {
            const iv = randomBytes(12);
            const data = textEncoder.encode(JSON.stringify(obj));
            const cipherBuf = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, data);
            return {
                iv: bufToBase64(iv.buffer),
                cipher: bufToBase64(cipherBuf),
            };
        }

        async function decryptJson(payload, key) {
            const iv = base64ToBuf(payload.iv);
            const cipher = base64ToBuf(payload.cipher);
            const plainBuf = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: new Uint8Array(iv) }, key, cipher);
            const text = textDecoder.decode(plainBuf);
            return JSON.parse(text || '{}');
        }

        // ----------------------------
        // App state
        // ----------------------------

        const appState = {
            key: null,
            data: null,
            selectedId: null,
        };

        function isVaultInitialized() {
            return !!(localStorage.getItem('pm_masterSalt') && localStorage.getItem('pm_masterCheck'));
        }

        function getVaultPayload() {
            const raw = localStorage.getItem('pm_encryptedData');
            if (!raw) return null;
            try {
                return JSON.parse(raw);
            } catch {
                return null;
            }
        }

        function setVaultPayload(payload) {
            localStorage.setItem('pm_encryptedData', JSON.stringify(payload));
        }

        // ----------------------------
        // Theme handling
        // ----------------------------

        function applyTheme(theme) {
            const root = document.documentElement;
            if (theme === 'dark') {
                root.classList.add('dark');
                document.body.classList.add('bg-slate-950');
            } else {
                root.classList.remove('dark');
            }
            const icon = document.getElementById('themeIcon');
            if (icon) icon.textContent = theme === 'dark' ? '‚òæ' : '‚òÄ';
            localStorage.setItem('pm_theme', theme);
        }

        function initTheme() {
            const saved = localStorage.getItem('pm_theme');
            if (saved === 'light' || saved === 'dark') {
                applyTheme(saved);
            } else {
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(prefersDark ? 'dark' : 'dark');
            }
        }

        // ----------------------------
        // Password strength estimation
        // ----------------------------

        function estimateStrength(pw) {
            if (!pw || typeof pw !== 'string' || !pw.length) {
                return { score: 0, label: 'n/a', detail: '' };
            }
            let score = 0;
            const len = pw.length;
            if (len >= 8) score += 1;
            if (len >= 12) score += 1;
            if (len >= 16) score += 1;
            const hasLower = /[a-z]/.test(pw);
            const hasUpper = /[A-Z]/.test(pw);
            const hasNumber = /[0-9]/.test(pw);
            const hasSymbol = /[^A-Za-z0-9]/.test(pw);
            const variety = [hasLower, hasUpper, hasNumber, hasSymbol].filter(Boolean).length;
            if (variety >= 2) score += 1;
            if (variety >= 3) score += 1;
            if (variety === 4) score += 1;
            if (/^(.)\1+$/.test(pw)) score = 0; // all same char
            const common = ['password', '123456', 'qwerty', 'letmein', 'welcome', 'admin'];
            const lowered = pw.toLowerCase();
            if (common.some(c => lowered.includes(c))) score = Math.min(score, 1);
            let label = 'Weak';
            if (score <= 1) label = 'Very weak';
            else if (score === 2) label = 'Weak';
            else if (score === 3) label = 'Fair';
            else if (score === 4) label = 'Strong';
            else label = 'Very strong';
            const detailParts = [];
            if (len < 12) detailParts.push('short length');
            if (variety < 3) detailParts.push('low character variety');
            return { score: Math.max(0, Math.min(5, score)), label, detail: detailParts.join(', ') };
        }

        function renderStrength(pw) {
            const { score, label, detail } = estimateStrength(pw);
            const bar = document.getElementById('strengthBar');
            const labelEl = document.getElementById('strengthLabel');
            const detailEl = document.getElementById('strengthDetail');
            if (!bar || !labelEl || !detailEl) return;
            const pct = (score / 5) * 100;
            bar.style.width = pct + '%';
            let color = 'bg-red-500';
            if (score >= 4) color = 'bg-emerald-500';
            else if (score === 3) color = 'bg-yellow-500';
            else if (score === 2) color = 'bg-orange-500';
            bar.className = 'h-full w-0 rounded-full transition-all ' + color;
            bar.style.width = pct + '%';
            labelEl.textContent = 'Strength: ' + label;
            detailEl.textContent = detail || '';
        }

        // ----------------------------
        // Password generator
        // ----------------------------

        function generatePassword(options) {
            const {
                length = 20,
                lower = true,
                upper = true,
                numbers = true,
                symbols = false,
                noAmbiguous = true,
            } = options || {};

            let lowerChars = 'abcdefghijklmnopqrstuvwxyz';
            let upperChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let numberChars = '0123456789';
            let symbolChars = '!@#$%^&*()-_=+[]{};:,.<>?/\\|';
            if (noAmbiguous) {
                lowerChars = lowerChars.replace(/[lio]/g, '');
                upperChars = upperChars.replace(/[OIL]/g, '');
                numberChars = numberChars.replace(/[01]/g, '');
            }

            let pool = '';
            const requiredSets = [];
            if (lower) {
                pool += lowerChars;
                requiredSets.push(lowerChars);
            }
            if (upper) {
                pool += upperChars;
                requiredSets.push(upperChars);
            }
            if (numbers) {
                pool += numberChars;
                requiredSets.push(numberChars);
            }
            if (symbols) {
                pool += symbolChars;
                requiredSets.push(symbolChars);
            }
            if (!pool) return '';

            const result = [];
            // Ensure at least one char from each selected set
            requiredSets.forEach(set => {
                const idx = crypto.getRandomValues(new Uint32Array(1))[0] % set.length;
                result.push(set[idx]);
            });
            for (let i = result.length; i < length; i++) {
                const idx = crypto.getRandomValues(new Uint32Array(1))[0] % pool.length;
                result.push(pool[idx]);
            }
            // Shuffle
            for (let i = result.length - 1; i > 0; i--) {
                const j = crypto.getRandomValues(new Uint32Array(1))[0] % (i + 1);
                [result[i], result[j]] = [result[j], result[i]];
            }
            return result.join('');
        }

        function initGenerator() {
            const modal = document.getElementById('generatorModal');
            const openBtn = document.getElementById('openGeneratorBtn');
            const closeBtn = document.getElementById('closeGeneratorBtn');
            const lengthInput = document.getElementById('genLength');
            const lengthValue = document.getElementById('genLengthValue');
            const output = document.getElementById('genOutput');
            const lower = document.getElementById('genLower');
            const upper = document.getElementById('genUpper');
            const numbers = document.getElementById('genNumbers');
            const symbols = document.getElementById('genSymbols');
            const noAmbiguous = document.getElementById('genNoAmbiguous');
            const errorEl = document.getElementById('genError');
            const genBtn = document.getElementById('genNewBtn');
            const copyBtn = document.getElementById('genCopyBtn');
            const useBtn = document.getElementById('genUseBtn');

            function syncLength() {
                lengthValue.textContent = lengthInput.value;
            }
            syncLength();

            function open() {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                errorEl.textContent = '';
                generateAndRender();
            }
            function close() {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }

            function generateAndRender() {
                const opts = {
                    length: parseInt(lengthInput.value, 10) || 20,
                    lower: lower.checked,
                    upper: upper.checked,
                    numbers: numbers.checked,
                    symbols: symbols.checked,
                    noAmbiguous: noAmbiguous.checked,
                };
                if (!opts.lower && !opts.upper && !opts.numbers && !opts.symbols) {
                    errorEl.textContent = 'Select at least one character set.';
                    output.value = '';
                    return;
                }
                const pw = generatePassword(opts);
                output.value = pw;
                errorEl.textContent = '';
            }

            openBtn.addEventListener('click', () => {
                open();
                updateActivity();
            });
            closeBtn.addEventListener('click', () => {
                close();
            });
            modal.addEventListener('click', (e) => {
                if (e.target === modal) close();
            });
            lengthInput.addEventListener('input', () => {
                syncLength();
                generateAndRender();
            });
            [lower, upper, numbers, symbols, noAmbiguous].forEach(el => {
                el.addEventListener('change', generateAndRender);
            });
            genBtn.addEventListener('click', () => {
                generateAndRender();
                updateActivity();
            });
            copyBtn.addEventListener('click', async () => {
                if (!output.value) return;
                try {
                    await navigator.clipboard.writeText(output.value);
                    showToast('Password copied to clipboard', 'success');
                } catch {
                    showToast('Could not copy password', 'error');
                }
            });
            useBtn.addEventListener('click', () => {
                const target = document.getElementById('entryPassword');
                if (target && output.value) {
                    target.value = output.value;
                    renderStrength(output.value);
                    close();
                }
            });
        }

        // ----------------------------
        // Entry list + form rendering
        // ----------------------------

        function getEntries() {
            return (appState.data && appState.data.entries) || [];
        }

        function setEntries(entries) {
            if (!appState.data) appState.data = { entries: [], lastId: 0 };
            appState.data.entries = entries;
        }

        function saveVault() {
            if (!appState.key || !appState.data) return;
            encryptJson(appState.data, appState.key)
                .then(payload => {
                    setVaultPayload(payload);
                })
                .catch(() => {
                    showToast('Failed to save encrypted vault', 'error');
                });
        }

        function renderEntryList() {
            const listEl = document.getElementById('entryList');
            const searchEl = document.getElementById('searchInput');
            const sortEl = document.getElementById('sortSelect');
            const countEl = document.getElementById('entryCount');
            if (!listEl) return;
            const q = (searchEl.value || '').toLowerCase();
            const sort = sortEl.value;
            let entries = [...getEntries()];
            if (q) {
                entries = entries.filter(e => {
                    const tagsStr = (e.tags || []).join(' ');
                    const haystack = [e.name, e.username, e.site, e.url, tagsStr].filter(Boolean).join(' ').toLowerCase();
                    return haystack.includes(q);
                });
            }
            if (sort === 'name') {
                entries.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            } else if (sort === 'fav') {
                entries.sort((a, b) => {
                    const fa = !!a.favorite;
                    const fb = !!b.favorite;
                    if (fa === fb) return (b.updatedAt || '').localeCompare(a.updatedAt || '');
                    return fb - fa;
                });
            } else {
                entries.sort((a, b) => (b.updatedAt || '').localeCompare(a.updatedAt || ''));
            }
            countEl.textContent = entries.length + (entries.length === 1 ? ' entry' : ' entries');
            if (!entries.length) {
                listEl.innerHTML = '<div class="p-4 text-[11px] text-slate-500">No entries yet. Create your first entry with the <span class="text-slate-300 font-medium">New</span> button.</div>';
                return;
            }
            listEl.innerHTML = entries.map(e => {
                const isActive = e.id === appState.selectedId;
                const tagsStr = (e.tags || []).slice(0, 3).join(', ');
                const fav = e.favorite ? '‚òÖ' : '';
                return `
          <button data-id="${e.id}" class="w-full text-left px-3 py-2 flex flex-col gap-0.5 ${isActive ? 'bg-slate-800/80' : 'hover:bg-slate-900/80'}">
            <div class="flex items-center justify-between gap-2">
              <span class="truncate font-medium text-[13px] text-slate-100">${(e.name || 'Untitled')}</span>
              <span class="text-[11px] text-amber-300">${fav}</span>
            </div>
            <div class="flex items-center justify-between gap-2 text-[11px] text-slate-400">
              <span class="truncate">${e.username || e.email || ''}</span>
              <span class="truncate">${e.site || e.url || ''}</span>
            </div>
            ${tagsStr ? `<div class="text-[10px] text-slate-500 truncate">${tagsStr}</div>` : ''}
          </button>
        `;
            }).join('');

            Array.from(listEl.querySelectorAll('button[data-id]')).forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.getAttribute('data-id');
                    selectEntry(id ? Number(id) : null);
                    updateActivity();
                });
            });
        }

        function selectEntry(id) {
            const entry = getEntries().find(e => e.id === id);
            appState.selectedId = entry ? entry.id : null;
            const nameEl = document.getElementById('entryName');
            const siteEl = document.getElementById('entrySite');
            const userEl = document.getElementById('entryUsername');
            const emailEl = document.getElementById('entryEmail');
            const pwEl = document.getElementById('entryPassword');
            const urlEl = document.getElementById('entryUrl');
            const tagsEl = document.getElementById('entryTags');
            const notesEl = document.getElementById('entryNotes');
            const idEl = document.getElementById('entryId');
            const metaCreated = document.getElementById('metaCreated');
            const metaUpdated = document.getElementById('metaUpdated');
            const favToggle = document.getElementById('favoriteToggle');
            const detailTitle = document.getElementById('detailTitle');
            const detailSubtitle = document.getElementById('detailSubtitle');
            const dupBtn = document.getElementById('duplicateEntryBtn');
            const delBtn = document.getElementById('deleteEntryBtn');

            if (!entry) {
                idEl.value = '';
                nameEl.value = '';
                siteEl.value = '';
                userEl.value = '';
                emailEl.value = '';
                pwEl.value = '';
                urlEl.value = '';
                tagsEl.value = '';
                notesEl.value = '';
                metaCreated.textContent = 'Created: ‚Äî';
                metaUpdated.textContent = 'Updated: ‚Äî';
                favToggle.classList.add('hidden');
                dupBtn.disabled = true;
                delBtn.disabled = true;
                detailTitle.textContent = 'No entry selected';
                detailSubtitle.textContent = 'Create a new entry or select one from the list.';
                renderStrength('');
            } else {
                idEl.value = entry.id;
                nameEl.value = entry.name || '';
                siteEl.value = entry.site || '';
                userEl.value = entry.username || '';
                emailEl.value = entry.email || '';
                pwEl.value = entry.password || '';
                urlEl.value = entry.url || '';
                tagsEl.value = (entry.tags || []).join(', ');
                notesEl.value = entry.notes || '';
                metaCreated.textContent = 'Created: ' + formatDateTime(entry.createdAt);
                metaUpdated.textContent = 'Updated: ' + formatDateTime(entry.updatedAt);
                favToggle.classList.remove('hidden');
                favToggle.textContent = entry.favorite ? '‚òÖ Favorited' : '‚òÜ Mark as favorite';
                favToggle.dataset.active = entry.favorite ? '1' : '0';
                dupBtn.disabled = false;
                delBtn.disabled = false;
                detailTitle.textContent = entry.name || 'Untitled entry';
                detailSubtitle.textContent = entry.site || entry.url || 'Stored credentials and notes.';
                renderStrength(entry.password || '');
            }
            renderEntryList();
        }

        function collectFormData() {
            const id = document.getElementById('entryId').value;
            const name = document.getElementById('entryName').value.trim();
            const site = document.getElementById('entrySite').value.trim();
            const username = document.getElementById('entryUsername').value.trim();
            const email = document.getElementById('entryEmail').value.trim();
            const password = document.getElementById('entryPassword').value;
            const url = document.getElementById('entryUrl').value.trim();
            const tagsRaw = document.getElementById('entryTags').value;
            const notes = document.getElementById('entryNotes').value;
            const tags = tagsRaw
                .split(',')
                .map(t => t.trim())
                .filter(Boolean);
            return {
                id: id ? Number(id) : null,
                name,
                site,
                username,
                email,
                password,
                url,
                tags,
                notes,
            };
        }

        function upsertEntry() {
            const data = collectFormData();
            let entries = getEntries();
            const now = new Date().toISOString();
            if (!data.id) {
                const newId = Date.now();
                const newEntry = {
                    id: newId,
                    name: data.name || 'Untitled',
                    site: data.site || '',
                    username: data.username || '',
                    email: data.email || '',
                    password: data.password || '',
                    url: data.url || '',
                    tags: data.tags || [],
                    notes: data.notes || '',
                    favorite: false,
                    createdAt: now,
                    updatedAt: now,
                };
                entries.push(newEntry);
                setEntries(entries);
                appState.selectedId = newId;
                saveVault();
                renderEntryList();
                selectEntry(newId);
                showToast('Entry created', 'success');
            } else {
                entries = entries.map(e => {
                    if (e.id !== data.id) return e;
                    return {
                        ...e,
                        name: data.name || 'Untitled',
                        site: data.site || '',
                        username: data.username || '',
                        email: data.email || '',
                        password: data.password || '',
                        url: data.url || '',
                        tags: data.tags || [],
                        notes: data.notes || '',
                        updatedAt: now,
                    };
                });
                setEntries(entries);
                saveVault();
                renderEntryList();
                selectEntry(data.id);
                showToast('Entry updated', 'success');
            }
        }

        function deleteEntry() {
            const id = document.getElementById('entryId').value;
            if (!id) return;
            if (!confirm('Delete this entry permanently?')) return;
            let entries = getEntries();
            entries = entries.filter(e => e.id !== Number(id));
            setEntries(entries);
            saveVault();
            appState.selectedId = null;
            selectEntry(null);
            showToast('Entry deleted', 'success');
        }

        function duplicateEntry() {
            const id = document.getElementById('entryId').value;
            if (!id) return;
            const src = getEntries().find(e => e.id === Number(id));
            if (!src) return;
            const now = new Date().toISOString();
            const newId = Date.now();
            const copy = {
                ...src,
                id: newId,
                name: (src.name || 'Untitled') + ' (copy)',
                createdAt: now,
                updatedAt: now,
            };
            const entries = getEntries();
            entries.push(copy);
            setEntries(entries);
            saveVault();
            appState.selectedId = newId;
            selectEntry(newId);
            showToast('Entry duplicated', 'success');
        }

        function toggleFavorite() {
            const id = document.getElementById('entryId').value;
            if (!id) return;
            const entries = getEntries().map(e => {
                if (e.id !== Number(id)) return e;
                const fav = !e.favorite;
                return { ...e, favorite: fav, updatedAt: new Date().toISOString() };
            });
            setEntries(entries);
            saveVault();
            const entry = entries.find(e => e.id === Number(id));
            if (entry) selectEntry(entry.id);
        }

        // ----------------------------
        // Lock / Unlock / Setup
        // ----------------------------

        function showLockedUI(mode) {
            const lockedView = document.getElementById('lockedView');
            const appView = document.getElementById('appView');
            const setupForm = document.getElementById('setupForm');
            const unlockForm = document.getElementById('unlockForm');
            const setupTab = document.getElementById('setupTab');
            const unlockTab = document.getElementById('unlockTab');
            const lockedTitle = document.getElementById('lockedTitle');
            const lockedSubtitle = document.getElementById('lockedSubtitle');

            lockedView.classList.remove('hidden');
            appView.classList.add('hidden');
            document.getElementById('exportBtn').classList.add('hidden');
            document.getElementById('importBtn').classList.add('hidden');
            document.getElementById('lockBtn').classList.add('hidden');

            if (mode === 'setup') {
                setupForm.classList.remove('hidden');
                unlockForm.classList.add('hidden');
                setupTab.classList.add('bg-slate-900', 'text-slate-100', 'font-medium');
                unlockTab.classList.remove('bg-slate-900', 'text-slate-100', 'font-medium');
                lockedTitle.textContent = 'Create master password';
                lockedSubtitle.textContent = 'Your data is encrypted locally using your master password. It cannot be recovered if you forget it.';
            } else {
                setupForm.classList.add('hidden');
                unlockForm.classList.remove('hidden');
                unlockTab.classList.add('bg-slate-900', 'text-slate-100', 'font-medium');
                setupTab.classList.remove('bg-slate-900', 'text-slate-100', 'font-medium');
                lockedTitle.textContent = 'Unlock your vault';
                const hint = localStorage.getItem('pm_masterHint');
                lockedSubtitle.textContent = hint ? 'Hint: ' + hint : 'Enter your master password to decrypt your vault.';
            }
        }

        function showAppUI() {
            const lockedView = document.getElementById('lockedView');
            const appView = document.getElementById('appView');
            lockedView.classList.add('hidden');
            appView.classList.remove('hidden');
            document.getElementById('exportBtn').classList.remove('hidden');
            document.getElementById('importBtn').classList.remove('hidden');
            document.getElementById('lockBtn').classList.remove('hidden');
            renderEntryList();
            selectEntry(appState.selectedId);
        }

        async function initializeVault(password, hint) {
            const { key, saltB64 } = await deriveKey(password);
            const checkPayload = await encryptJson({ token: 'secure-vault-check' }, key);
            localStorage.setItem('pm_masterSalt', saltB64);
            localStorage.setItem('pm_masterCheck', JSON.stringify(checkPayload));
            if (hint) localStorage.setItem('pm_masterHint', hint);
            appState.key = key;
            appState.data = { entries: [], lastId: 0 };
            const vaultPayload = await encryptJson(appState.data, key);
            setVaultPayload(vaultPayload);
        }

        async function unlockVault(password) {
            const salt = localStorage.getItem('pm_masterSalt');
            const checkRaw = localStorage.getItem('pm_masterCheck');
            if (!salt || !checkRaw) throw new Error('Vault not initialized');
            const { key } = await deriveKey(password, salt);
            const checkPayload = JSON.parse(checkRaw);
            const check = await decryptJson(checkPayload, key);
            if (!check || check.token !== 'secure-vault-check') {
                throw new Error('Invalid master password');
            }
            let vault = getVaultPayload();
            if (!vault) {
                appState.key = key;
                appState.data = { entries: [], lastId: 0 };
                const payload = await encryptJson(appState.data, key);
                setVaultPayload(payload);
                return;
            }
            const data = await decryptJson(vault, key);
            if (!data || !Array.isArray(data.entries)) {
                throw new Error('Vault data is corrupted');
            }
            appState.key = key;
            appState.data = data;
        }

        function lockVault() {
            appState.key = null;
            appState.data = null;
            appState.selectedId = null;
            document.getElementById('unlockMaster').value = '';
            document.getElementById('unlockError').textContent = '';
            showLockedUI('unlock');
            showToast('Vault locked', 'info');
        }

        function initLockUI() {
            const setupTab = document.getElementById('setupTab');
            const unlockTab = document.getElementById('unlockTab');
            const setupForm = document.getElementById('setupForm');
            const unlockForm = document.getElementById('unlockForm');

            if (isVaultInitialized()) {
                showLockedUI('unlock');
            } else {
                showLockedUI('setup');
            }

            const hint = localStorage.getItem('pm_masterHint');
            const hintText = document.getElementById('hintText');
            if (hintText) hintText.textContent = hint ? 'Hint: ' + hint : '';

            setupTab.addEventListener('click', () => showLockedUI('setup'));
            unlockTab.addEventListener('click', () => showLockedUI('unlock'));

            setupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const pw = document.getElementById('setupMaster').value;
                const pw2 = document.getElementById('setupMasterConfirm').value;
                const hintInput = document.getElementById('setupHint').value.trim();
                const errEl = document.getElementById('setupError');
                errEl.textContent = '';
                if (pw.length < 8) {
                    errEl.textContent = 'Use at least 8 characters (preferably 12+).';
                    return;
                }
                if (pw !== pw2) {
                    errEl.textContent = 'Passwords do not match.';
                    return;
                }
                try {
                    await initializeVault(pw, hintInput);
                    showToast('Vault initialized', 'success');
                    showAppUI();
                    updateActivity();
                } catch (err) {
                    console.error(err);
                    errEl.textContent = 'Failed to initialize vault. Your browser might not support required crypto APIs.';
                }
            });

            unlockForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const pw = document.getElementById('unlockMaster').value;
                const errEl = document.getElementById('unlockError');
                errEl.textContent = '';
                try {
                    await unlockVault(pw);
                    showToast('Vault unlocked', 'success');
                    showAppUI();
                    updateActivity();
                } catch (err) {
                    console.error(err);
                    errEl.textContent = 'Incorrect master password or corrupted data.';
                }
            });
        }

        // ----------------------------
        // Import / Export
        // ----------------------------

        function initImportExport() {
            const exportBtn = document.getElementById('exportBtn');
            const importBtn = document.getElementById('importBtn');
            const fileInput = document.getElementById('importFileInput');

            exportBtn.addEventListener('click', () => {
                if (!appState.data) return;
                const blob = new Blob([JSON.stringify(appState.data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'securevault-backup-' + new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-') + '.json';
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                showToast('Exported vault as JSON', 'success');
            });

            importBtn.addEventListener('click', () => {
                fileInput.value = '';
                fileInput.click();
            });

            fileInput.addEventListener('change', () => {
                const file = fileInput.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!data || !Array.isArray(data.entries)) throw new Error('Invalid format');
                        if (!confirm('Importing will replace your current entries with the file contents. Continue?')) return;
                        appState.data = data;
                        saveVault();
                        renderEntryList();
                        selectEntry(null);
                        showToast('Imported vault data', 'success');
                    } catch (err) {
                        console.error(err);
                        showToast('Failed to import: invalid file', 'error');
                    }
                };
                reader.readAsText(file);
            });
        }

        // ----------------------------
        // Auto-lock
        // ----------------------------

        function initAutoLock() {
            const select = document.getElementById('autoLockSelect');
            select.addEventListener('change', () => {
                const val = select.value;
                localStorage.setItem('pm_autoLockMinutes', val);
            });
            const saved = localStorage.getItem('pm_autoLockMinutes');
            if (saved && select.querySelector('option[value="' + saved + '"]')) {
                select.value = saved;
            }
            window._lastActivity = Date.now();
            ['click', 'keydown', 'mousemove', 'touchstart'].forEach(evt => {
                document.addEventListener(evt, updateActivity, { passive: true });
            });
            setInterval(() => {
                const minutes = parseInt(localStorage.getItem('pm_autoLockMinutes') || select.value, 10);
                if (!minutes || !appState.key) return;
                const now = Date.now();
                if (now - (window._lastActivity || 0) > minutes * 60 * 1000) {
                    lockVault();
                }
            }, 15000);
        }

        // ----------------------------
        // Clipboard helpers
        // ----------------------------

        function initCopyButtons() {
            document.querySelectorAll('.copyBtn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const targetId = btn.getAttribute('data-copy-target');
                    const input = document.getElementById(targetId);
                    if (!input || !input.value) return;
                    try {
                        await navigator.clipboard.writeText(input.value);
                        showToast('Copied to clipboard', 'success');
                    } catch {
                        showToast('Copy failed', 'error');
                    }
                });
            });
        }

        // ----------------------------
        // Main init
        // ----------------------------

        window.addEventListener('DOMContentLoaded', () => {
            initTheme();
            document.getElementById('themeToggle').addEventListener('click', () => {
                const current = localStorage.getItem('pm_theme') || 'dark';
                applyTheme(current === 'dark' ? 'light' : 'dark');
            });

            initLockUI();
            initGenerator();
            initImportExport();
            initAutoLock();
            initCopyButtons();

            const pwInput = document.getElementById('entryPassword');
            pwInput.addEventListener('input', (e) => {
                renderStrength(e.target.value);
            });

            document.getElementById('togglePassword').addEventListener('click', () => {
                const type = pwInput.getAttribute('type') === 'password' ? 'text' : 'password';
                pwInput.setAttribute('type', type);
                document.getElementById('togglePassword').textContent = type === 'password' ? 'Show' : 'Hide';
            });

            document.getElementById('entryForm').addEventListener('submit', (e) => {
                e.preventDefault();
                upsertEntry();
                updateActivity();
            });

            document.getElementById('deleteEntryBtn').addEventListener('click', () => {
                deleteEntry();
                updateActivity();
            });
            document.getElementById('duplicateEntryBtn').addEventListener('click', () => {
                duplicateEntry();
                updateActivity();
            });
            document.getElementById('newEntryBtn').addEventListener('click', () => {
                appState.selectedId = null;
                selectEntry(null);
            });
            document.getElementById('addEntryBtn').addEventListener('click', () => {
                appState.selectedId = null;
                selectEntry(null);
            });

            document.getElementById('favoriteToggle').addEventListener('click', () => {
                toggleFavorite();
                updateActivity();
            });

            document.getElementById('searchInput').addEventListener('input', () => {
                renderEntryList();
            });
            document.getElementById('sortSelect').addEventListener('change', () => {
                renderEntryList();
            });

            document.getElementById('lockBtn').addEventListener('click', () => {
                lockVault();
            });
        });
    </script>
</body>

</html>