<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FlashReader — PDF/Text Speed Reader</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.5.136/build/pdf.min.js"></script>
    <style>
        :root {
            color-scheme: dark;
        }

        /* Subtle animations */
        @keyframes popIn {
            0% {
                transform: translateY(6px) scale(.985);
                opacity: 0;
            }

            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .pop-in {
            animation: popIn 160ms ease-out;
        }

        /* Improve range styling a bit */
        input[type="range"] {
            accent-color: rgb(99 102 241);
        }

        /* Hide scrollbars but keep scroll */
        .no-scrollbar::-webkit-scrollbar {
            width: 0;
            height: 0;
        }

        .no-scrollbar {
            scrollbar-width: none;
        }

        /* Better selection */
        ::selection {
            background: rgba(99, 102, 241, .35);
        }

        /* Focus ring */
        .focus-ring:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, .35);
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-slate-100">
    <div class="pointer-events-none fixed inset-0 opacity-60" aria-hidden="true"
        style="background: radial-gradient(900px 500px at 15% 20%, rgba(99,102,241,.25), transparent 60%), radial-gradient(800px 500px at 85% 35%, rgba(20,184,166,.18), transparent 60%), radial-gradient(700px 500px at 40% 90%, rgba(244,63,94,.10), transparent 60%);">
    </div>

    <header class="relative mx-auto max-w-7xl px-4 pt-8 pb-4">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
            <div>
                <h1 class="text-2xl sm:text-3xl font-semibold tracking-tight">
                    FlashReader <span class="text-slate-400 font-medium">— one word at a time</span>
                </h1>
                <p class="mt-1 text-sm text-slate-300/80 max-w-3xl">
                    Paste text or import TXT/PDF and read at a controlled pace. Tune WPM, see the equivalent in
                    pages/min, use smart pauses, and track ETA.
                </p>
            </div>
            <div class="flex items-center gap-2">
                <button id="btnFocus"
                    class="focus-ring rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 px-3 py-2 text-sm">
                    Focus mode
                </button>
                <button id="btnTheme"
                    class="focus-ring rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 px-3 py-2 text-sm">
                    Toggle theme
                </button>
                <a class="rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 px-3 py-2 text-sm" href="#"
                    id="btnHelp">Shortcuts</a>
            </div>
        </div>
    </header>

    <main class="relative mx-auto max-w-7xl px-4 pb-10">
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-4">
            <!-- Left: input & settings -->
            <section class="lg:col-span-2">
                <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur p-4">
                    <div class="flex items-center justify-between gap-3">
                        <h2 class="text-sm font-semibold text-slate-200">Input</h2>
                        <div class="flex items-center gap-2 text-xs">
                            <button id="btnExample1"
                                class="focus-ring rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 px-2.5 py-1.5">Load
                                example 1</button>
                            <button id="btnExample2"
                                class="focus-ring rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 px-2.5 py-1.5">Load
                                example 2</button>
                            <button id="btnExample3"
                                class="focus-ring rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 px-2.5 py-1.5">Load
                                example 3</button>
                        </div>
                    </div>

                    <div id="dropzone" class="mt-3 rounded-xl border border-dashed border-white/15 bg-white/5 p-3">
                        <div class="flex flex-col sm:flex-row sm:items-center gap-3 justify-between">
                            <div class="text-xs text-slate-300/80">
                                <div class="font-medium text-slate-200">Drop a <span class="text-indigo-300">.pdf</span>
                                    or <span class="text-teal-300">.txt</span> here</div>
                                <div class="mt-0.5">Or use the buttons to import. Your data stays in your browser.</div>
                            </div>
                            <div class="flex items-center gap-2">
                                <label
                                    class="focus-ring cursor-pointer rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 px-3 py-2 text-xs">
                                    <input id="fileTxt" type="file" accept=".txt,text/plain" class="hidden" />
                                    Import TXT
                                </label>
                                <label
                                    class="focus-ring cursor-pointer rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 px-3 py-2 text-xs">
                                    <input id="filePdf" type="file" accept="application/pdf" class="hidden" />
                                    Import PDF
                                </label>
                            </div>
                        </div>
                        <div id="importStatus" class="mt-2 text-xs text-slate-300/80"></div>
                    </div>

                    <div class="mt-3">
                        <label class="text-xs text-slate-300/80">Text</label>
                        <textarea id="textInput"
                            class="focus-ring mt-1 w-full min-h-[180px] rounded-xl border border-white/10 bg-slate-950/30 p-3 text-sm leading-relaxed"
                            placeholder="Paste text here… (PDF import will place extracted text here)"></textarea>
                        <div class="mt-2 flex flex-wrap gap-2">
                            <button id="btnPrepare"
                                class="focus-ring rounded-xl bg-indigo-600/90 hover:bg-indigo-600 px-3 py-2 text-sm font-medium">Prepare
                                reader</button>
                            <button id="btnClear"
                                class="focus-ring rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 px-3 py-2 text-sm">Clear</button>
                            <button id="btnCopy"
                                class="focus-ring rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 px-3 py-2 text-sm">Copy
                                text</button>
                            <button id="btnDownload"
                                class="focus-ring rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 px-3 py-2 text-sm">Download
                                TXT</button>
                        </div>
                    </div>

                    <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div class="rounded-xl border border-white/10 bg-white/5 p-3">
                            <div class="flex items-center justify-between">
                                <label class="text-xs text-slate-300/80">Speed (WPM)</label>
                                <button id="btnTap"
                                    class="focus-ring rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 px-2 py-1 text-xs">Tap
                                    tempo</button>
                            </div>
                            <div class="mt-2 flex items-center gap-2">
                                <input id="wpmRange" type="range" min="60" max="1200" step="5" class="w-full" />
                                <input id="wpmInput" type="number" min="60" max="1200" step="5"
                                    class="focus-ring w-24 rounded-lg border border-white/10 bg-slate-950/30 px-2 py-1 text-sm" />
                            </div>
                            <div class="mt-2 flex flex-wrap items-center gap-2 text-xs">
                                <button data-preset="200"
                                    class="preset focus-ring rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 px-2 py-1">200</button>
                                <button data-preset="300"
                                    class="preset focus-ring rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 px-2 py-1">300</button>
                                <button data-preset="400"
                                    class="preset focus-ring rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 px-2 py-1">400</button>
                                <button data-preset="600"
                                    class="preset focus-ring rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 px-2 py-1">600</button>
                                <span class="ml-auto text-slate-300/80" id="pagesPerMinLabel">—</span>
                            </div>
                        </div>

                        <div class="rounded-xl border border-white/10 bg-white/5 p-3">
                            <label class="text-xs text-slate-300/80">Display</label>
                            <div class="mt-2 grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[11px] text-slate-300/80">Words per flash</label>
                                    <select id="chunkSelect"
                                        class="focus-ring mt-1 w-full rounded-lg border border-white/10 bg-slate-950/30 px-2 py-1.5 text-sm">
                                        <option value="1">1 (classic)</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[11px] text-slate-300/80">Words per page</label>
                                    <input id="wordsPerPage" type="number" min="100" max="1000" step="10"
                                        class="focus-ring mt-1 w-full rounded-lg border border-white/10 bg-slate-950/30 px-2 py-1.5 text-sm" />
                                </div>
                            </div>
                            <div class="mt-2 space-y-2">
                                <label class="flex items-center gap-2 text-xs text-slate-200">
                                    <input id="smartPauses" type="checkbox" class="h-4 w-4" />
                                    Smart pauses (punctuation / long words)
                                </label>
                                <label class="flex items-center gap-2 text-xs text-slate-200">
                                    <input id="fixHyphens" type="checkbox" class="h-4 w-4" />
                                    Fix PDF hyphenation (-\n)
                                </label>
                                <label class="flex items-center gap-2 text-xs text-slate-200">
                                    <input id="stripExtraWhitespace" type="checkbox" class="h-4 w-4" />
                                    Normalize whitespace
                                </label>
                                <label class="flex items-center gap-2 text-xs text-slate-200">
                                    <input id="highlightText" type="checkbox" class="h-4 w-4" />
                                    Show full text with highlight
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 rounded-xl border border-white/10 bg-white/5 p-3">
                        <div class="flex items-center justify-between">
                            <h3 class="text-sm font-semibold text-slate-200">Stats</h3>
                            <button id="btnSave"
                                class="focus-ring rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 px-2 py-1 text-xs">Save</button>
                        </div>
                        <div class="mt-2 grid grid-cols-2 gap-2 text-xs text-slate-300/80">
                            <div class="rounded-lg bg-slate-950/30 border border-white/10 p-2">
                                <div class="text-[11px]">Words</div>
                                <div id="statWords" class="text-slate-100 font-medium">—</div>
                            </div>
                            <div class="rounded-lg bg-slate-950/30 border border-white/10 p-2">
                                <div class="text-[11px]">Estimated time</div>
                                <div id="statTime" class="text-slate-100 font-medium">—</div>
                            </div>
                            <div class="rounded-lg bg-slate-950/30 border border-white/10 p-2">
                                <div class="text-[11px]">Pages (approx)</div>
                                <div id="statPages" class="text-slate-100 font-medium">—</div>
                            </div>
                            <div class="rounded-lg bg-slate-950/30 border border-white/10 p-2">
                                <div class="text-[11px]">Pages / min</div>
                                <div id="statPPM" class="text-slate-100 font-medium">—</div>
                            </div>
                        </div>
                        <div class="mt-3 text-[11px] text-slate-300/70">
                            Tip: Use <span class="text-slate-200">Space</span> to play/pause, <span
                                class="text-slate-200">←/→</span> to step, <span class="text-slate-200">Shift+←/→</span>
                            to jump 10.
                        </div>
                    </div>
                </div>
            </section>

            <!-- Right: reader -->
            <section class="lg:col-span-3">
                <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur p-4">
                    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                        <div class="min-w-0">
                            <h2 class="text-sm font-semibold text-slate-200">Reader</h2>
                            <div class="mt-1 text-xs text-slate-300/80" id="readerMeta">Load text and press “Prepare
                                reader”.</div>
                        </div>
                        <div class="flex flex-wrap items-center gap-2">
                            <button id="btnBack"
                                class="focus-ring rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 px-3 py-2 text-sm">⟵
                                Back</button>
                            <button id="btnPlay"
                                class="focus-ring rounded-xl bg-indigo-600/90 hover:bg-indigo-600 px-3 py-2 text-sm font-medium">Play</button>
                            <button id="btnPause"
                                class="focus-ring rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 px-3 py-2 text-sm hidden">Pause</button>
                            <button id="btnForward"
                                class="focus-ring rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 px-3 py-2 text-sm">Forward
                                ⟶</button>
                            <button id="btnRestart"
                                class="focus-ring rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 px-3 py-2 text-sm">Restart</button>
                        </div>
                    </div>

                    <div class="mt-3 rounded-xl border border-white/10 bg-slate-950/30 p-4">
                        <div class="flex items-center justify-between gap-3">
                            <div class="text-xs text-slate-300/80">
                                <span id="posLabel">—</span>
                                <span class="mx-2 text-slate-600">•</span>
                                <span id="etaLabel">ETA: —</span>
                            </div>
                            <div class="text-xs text-slate-300/80" id="sessionLabel">Not started</div>
                        </div>
                        <div class="mt-3">
                            <div class="h-2 rounded-full bg-white/10 overflow-hidden cursor-pointer" id="progressBar"
                                role="slider" aria-label="Progress">
                                <div id="progressFill"
                                    class="h-full w-0 bg-gradient-to-r from-indigo-500 via-teal-400 to-fuchsia-500">
                                </div>
                            </div>
                            <div class="mt-2 flex items-center gap-2">
                                <input id="seek" type="range" min="0" max="0" value="0" step="1" class="w-full" />
                                <button id="btnMark"
                                    class="focus-ring rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 px-2 py-1 text-xs">Bookmark</button>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 rounded-2xl border border-white/10 bg-gradient-to-b from-white/5 to-white/0 p-6">
                        <div class="grid grid-cols-1 gap-4">
                            <div class="text-center">
                                <div class="text-xs text-slate-300/80" id="prevWord">&nbsp;</div>
                                <div class="mt-2">
                                    <div id="currentWord"
                                        class="pop-in text-4xl sm:text-6xl lg:text-7xl font-semibold tracking-tight leading-none">
                                        Ready
                                    </div>
                                    <div id="currentHint" class="mt-2 text-xs text-slate-300/70">Press Play (Space) when
                                        ready.</div>
                                </div>
                                <div class="mt-2 text-xs text-slate-300/80" id="nextWord">&nbsp;</div>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                <div class="rounded-xl border border-white/10 bg-slate-950/30 p-3">
                                    <div class="text-[11px] text-slate-300/70">Current speed</div>
                                    <div id="liveWpm" class="mt-1 text-slate-100 font-medium">—</div>
                                </div>
                                <div class="rounded-xl border border-white/10 bg-slate-950/30 p-3">
                                    <div class="text-[11px] text-slate-300/70">Equivalent pace</div>
                                    <div id="livePace" class="mt-1 text-slate-100 font-medium">—</div>
                                </div>
                                <div class="rounded-xl border border-white/10 bg-slate-950/30 p-3">
                                    <div class="text-[11px] text-slate-300/70">Chunk</div>
                                    <div id="liveChunk" class="mt-1 text-slate-100 font-medium">—</div>
                                </div>
                            </div>

                            <div id="fullTextWrap" class="hidden rounded-xl border border-white/10 bg-slate-950/30 p-3">
                                <div class="flex items-center justify-between">
                                    <div class="text-xs text-slate-300/80">Full text (highlighted)</div>
                                    <button id="btnReRender"
                                        class="focus-ring rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 px-2 py-1 text-xs">Re-render</button>
                                </div>
                                <div id="fullText"
                                    class="no-scrollbar mt-2 max-h-52 overflow-auto text-sm leading-relaxed text-slate-200">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div class="rounded-xl border border-white/10 bg-white/5 p-3">
                            <h3 class="text-sm font-semibold text-slate-200">Bookmarks</h3>
                            <div class="mt-2 text-xs text-slate-300/80" id="bookmarkHint">Save your place and jump back
                                later.</div>
                            <div id="bookmarkList" class="mt-2 space-y-2"></div>
                        </div>
                        <div class="rounded-xl border border-white/10 bg-white/5 p-3">
                            <h3 class="text-sm font-semibold text-slate-200">Tools</h3>
                            <div class="mt-2 grid grid-cols-2 gap-2">
                                <button id="btnStepBack"
                                    class="focus-ring rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 px-3 py-2 text-sm">Step
                                    ←</button>
                                <button id="btnStepForward"
                                    class="focus-ring rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 px-3 py-2 text-sm">Step
                                    →</button>
                                <button id="btnJumpBack"
                                    class="focus-ring rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 px-3 py-2 text-sm">Jump
                                    -10</button>
                                <button id="btnJumpForward"
                                    class="focus-ring rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 px-3 py-2 text-sm">Jump
                                    +10</button>
                            </div>
                            <div class="mt-2 text-[11px] text-slate-300/70">
                                Mouse: click the progress bar to seek. Keyboard: <span class="text-slate-200">F</span>
                                focus, <span class="text-slate-200">Esc</span> exit.
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Modals -->
    <div id="modalHelp" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/60" data-close="true"></div>
        <div class="relative mx-auto mt-16 max-w-xl px-4">
            <div class="rounded-2xl border border-white/10 bg-slate-950/80 backdrop-blur p-5">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold">Keyboard shortcuts</h2>
                    <button
                        class="focus-ring rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 px-2 py-1 text-sm"
                        data-close="true">Close</button>
                </div>
                <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm text-slate-200">
                    <div class="rounded-xl border border-white/10 bg-white/5 p-3">
                        <div class="font-medium">Playback</div>
                        <ul class="mt-2 space-y-1 text-slate-300/90">
                            <li><span class="text-slate-100">Space</span> — play/pause</li>
                            <li><span class="text-slate-100">←/→</span> — step 1</li>
                            <li><span class="text-slate-100">Shift + ←/→</span> — jump 10</li>
                            <li><span class="text-slate-100">R</span> — restart</li>
                        </ul>
                    </div>
                    <div class="rounded-xl border border-white/10 bg-white/5 p-3">
                        <div class="font-medium">Speed & UI</div>
                        <ul class="mt-2 space-y-1 text-slate-300/90">
                            <li><span class="text-slate-100">↑/↓</span> — WPM ±10</li>
                            <li><span class="text-slate-100">F</span> — focus mode</li>
                            <li><span class="text-slate-100">Esc</span> — exit focus / close modal</li>
                            <li><span class="text-slate-100">B</span> — bookmark</li>
                        </ul>
                    </div>
                </div>
                <p class="mt-3 text-xs text-slate-300/80">
                    Tip: Click inside inputs to type normally (shortcuts won’t trigger while typing).
                </p>
            </div>
        </div>
    </div>

    <div id="toast" class="pointer-events-none fixed bottom-5 left-1/2 z-50 -translate-x-1/2 hidden">
        <div
            class="rounded-xl border border-white/10 bg-slate-950/85 backdrop-blur px-4 py-2 text-sm text-slate-100 shadow-lg">
            <span id="toastMsg">Saved</span>
        </div>
    </div>

    <script>
        // PDF.js worker config
        (function initPdfWorker() {
            try {
                if (window.pdfjsLib) {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.5.136/build/pdf.worker.min.js";
                }
            } catch (e) { }
        })();

        const $ = (id) => document.getElementById(id);

        const els = {
            textInput: $("textInput"),
            importStatus: $("importStatus"),
            dropzone: $("dropzone"),
            fileTxt: $("fileTxt"),
            filePdf: $("filePdf"),

            btnExample1: $("btnExample1"),
            btnExample2: $("btnExample2"),
            btnExample3: $("btnExample3"),
            btnPrepare: $("btnPrepare"),
            btnClear: $("btnClear"),
            btnCopy: $("btnCopy"),
            btnDownload: $("btnDownload"),

            wpmRange: $("wpmRange"),
            wpmInput: $("wpmInput"),
            pagesPerMinLabel: $("pagesPerMinLabel"),
            chunkSelect: $("chunkSelect"),
            wordsPerPage: $("wordsPerPage"),
            smartPauses: $("smartPauses"),
            fixHyphens: $("fixHyphens"),
            stripExtraWhitespace: $("stripExtraWhitespace"),
            highlightText: $("highlightText"),
            btnReRender: $("btnReRender"),
            btnSave: $("btnSave"),
            btnTap: $("btnTap"),

            statWords: $("statWords"),
            statTime: $("statTime"),
            statPages: $("statPages"),
            statPPM: $("statPPM"),

            readerMeta: $("readerMeta"),
            prevWord: $("prevWord"),
            currentWord: $("currentWord"),
            currentHint: $("currentHint"),
            nextWord: $("nextWord"),

            btnPlay: $("btnPlay"),
            btnPause: $("btnPause"),
            btnBack: $("btnBack"),
            btnForward: $("btnForward"),
            btnRestart: $("btnRestart"),

            posLabel: $("posLabel"),
            etaLabel: $("etaLabel"),
            sessionLabel: $("sessionLabel"),

            progressBar: $("progressBar"),
            progressFill: $("progressFill"),
            seek: $("seek"),

            liveWpm: $("liveWpm"),
            livePace: $("livePace"),
            liveChunk: $("liveChunk"),

            fullTextWrap: $("fullTextWrap"),
            fullText: $("fullText"),

            btnStepBack: $("btnStepBack"),
            btnStepForward: $("btnStepForward"),
            btnJumpBack: $("btnJumpBack"),
            btnJumpForward: $("btnJumpForward"),

            btnMark: $("btnMark"),
            bookmarkList: $("bookmarkList"),
            bookmarkHint: $("bookmarkHint"),

            btnTheme: $("btnTheme"),
            btnFocus: $("btnFocus"),
            btnHelp: $("btnHelp"),
            modalHelp: $("modalHelp"),

            toast: $("toast"),
            toastMsg: $("toastMsg"),
        };

        const STORAGE_KEY = "flashreader:v1";

        const EXAMPLES = {
            ex1: `In the beginning, the Universe was created. This has made a lot of people very angry and been widely regarded as a bad move.\n\nReading faster is not just about speed—it's about control. Adjust the pace, pause naturally at punctuation, and keep your attention on the center of the screen.`,
            ex2: `Productivity note:\n\n1) Set a goal.\n2) Remove distractions.\n3) Work in focused bursts.\n\nThen review: What worked? What didn’t? Iterate.\n\nFast reading is a tool—use it when skimming, and slow down when meaning matters.`,
            ex3: `A tiny “tech article” excerpt:\n\nHTTP is a stateless protocol. Cookies, sessions, and tokens are techniques layered on top to provide continuity.\n\nIf you see a long word—acknowledgement, internationalization, cryptographically—smart pauses can help your brain catch up.`
        };

        const state = {
            tokens: [],
            rawText: "",
            idx: 0,
            playing: false,
            timer: null,
            wpm: 400,
            chunk: 1,
            wordsPerPage: 250,
            smartPauses: true,
            fixHyphens: true,
            stripExtraWhitespace: true,
            highlightText: true,
            startedAt: null,
            pausedAt: null,
            elapsedMs: 0,
            theme: "dark",
            focus: false,
            bookmarks: [], // {name, idx, createdAt}

            tap: { lastTap: 0, times: [] }
        };

        // ---------- Utilities ----------
        function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

        function formatDuration(ms) {
            if (!isFinite(ms) || ms < 0) return "—";
            const s = Math.round(ms / 1000);
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = s % 60;
            if (h > 0) return `${h}h ${m}m`;
            if (m > 0) return `${m}m ${sec}s`;
            return `${sec}s`;
        }

        function formatMinutes(min) {
            if (!isFinite(min) || min < 0) return "—";
            const ms = min * 60 * 1000;
            return formatDuration(ms);
        }

        function toast(msg) {
            els.toastMsg.textContent = msg;
            els.toast.classList.remove("hidden");
            clearTimeout(toast._t);
            toast._t = setTimeout(() => els.toast.classList.add("hidden"), 1600);
        }

        function isTypingTarget(e) {
            const el = e.target;
            if (!el) return false;
            const tag = (el.tagName || "").toLowerCase();
            return tag === "textarea" || tag === "input" || tag === "select" || el.isContentEditable;
        }

        function normalizeText(txt) {
            let t = txt ?? "";
            if (state.fixHyphens) {
                // Common PDF artifact: hyphen at line end followed by newline
                t = t.replace(/-\s*\n\s*/g, "");
            }
            if (state.stripExtraWhitespace) {
                t = t.replace(/\r\n/g, "\n");
                t = t.replace(/[\t\f\v]+/g, " ");
                t = t.replace(/\u00a0/g, " ");
                t = t.replace(/\s+\n/g, "\n");
                t = t.replace(/\n\s+/g, "\n");
                t = t.replace(/\n{3,}/g, "\n\n");
                t = t.replace(/\s{2,}/g, " ");
            }
            return t.trim();
        }

        function tokenize(txt) {
            const t = normalizeText(txt);
            if (!t) return [];
            // Tokenize by whitespace; keep punctuation attached
            return t.split(/\s+/g).filter(Boolean);
        }

        function wordsPerMinuteToPagesPerMinute(wpm, wpp) {
            wpm = Number(wpm); wpp = Number(wpp);
            if (!isFinite(wpm) || !isFinite(wpp) || wpp <= 0) return NaN;
            return wpm / wpp;
        }

        function computeIntervalMs(token) {
            const basePerWord = 60000 / state.wpm;
            let interval = basePerWord * state.chunk;
            if (!state.smartPauses) return interval;

            const last = token || "";
            // punctuation pauses
            if (/[.!?]["')\]]?$/.test(last)) interval *= 1.75;
            else if (/[,;:]["')\]]?$/.test(last)) interval *= 1.25;

            // long word pause (slight)
            const letters = (last.match(/[A-Za-z]/g) || []).length;
            if (letters >= 12) interval *= 1.12;
            if (letters >= 18) interval *= 1.18;

            // numbers (often slower)
            if (/\d/.test(last) && letters < 3) interval *= 1.1;

            return interval;
        }

        // ---------- Rendering ----------
        function updateLiveLabels() {
            els.liveWpm.textContent = `${state.wpm} WPM`;
            const ppm = wordsPerMinuteToPagesPerMinute(state.wpm, state.wordsPerPage);
            els.livePace.textContent = isFinite(ppm)
                ? `${ppm.toFixed(ppm < 10 ? 2 : 1)} pages/min (≈ ${state.wordsPerPage} w/page)`
                : "—";
            els.liveChunk.textContent = `${state.chunk} word${state.chunk > 1 ? 's' : ''}/flash`;
            els.pagesPerMinLabel.textContent = isFinite(ppm)
                ? `${ppm.toFixed(ppm < 10 ? 2 : 1)} pages/min`
                : "—";

            els.statPPM.textContent = isFinite(ppm) ? ppm.toFixed(ppm < 10 ? 2 : 1) : "—";
        }

        function updateStats() {
            const wc = state.tokens.length;
            els.statWords.textContent = wc ? wc.toLocaleString() : "—";
            const minutes = wc ? wc / state.wpm : NaN;
            els.statTime.textContent = wc ? formatMinutes(minutes) : "—";
            const pages = (wc && state.wordsPerPage) ? (wc / state.wordsPerPage) : NaN;
            els.statPages.textContent = isFinite(pages) ? pages.toFixed(pages < 10 ? 2 : 1) : "—";
            updateLiveLabels();
        }

        function currentChunkText() {
            const from = state.idx;
            const to = Math.min(state.idx + state.chunk, state.tokens.length);
            return state.tokens.slice(from, to).join(" ");
        }

        function renderReader() {
            const wc = state.tokens.length;
            if (!wc) {
                els.readerMeta.textContent = "Load text and press “Prepare reader”.";
                els.currentWord.textContent = "Ready";
                els.currentHint.textContent = "Paste text / import PDF/TXT, then press Prepare reader.";
                els.prevWord.innerHTML = "&nbsp;";
                els.nextWord.innerHTML = "&nbsp;";
                els.posLabel.textContent = "—";
                els.etaLabel.textContent = "ETA: —";
                els.sessionLabel.textContent = "Not started";
                els.progressFill.style.width = "0%";
                els.seek.max = 0;
                els.seek.value = 0;
                renderFullTextMaybe();
                return;
            }

            state.idx = clamp(state.idx, 0, wc - 1);

            const prev = state.tokens[state.idx - 1] || "";
            const next = state.tokens[state.idx + state.chunk] || "";
            const chunk = currentChunkText();

            // Animate by toggling class
            els.currentWord.classList.remove("pop-in");
            void els.currentWord.offsetWidth;
            els.currentWord.classList.add("pop-in");

            els.currentWord.textContent = chunk || "";
            els.currentHint.textContent = state.playing ? "" : "Press Play (Space) to continue.";
            els.prevWord.textContent = prev ? `← ${prev}` : "";
            els.nextWord.textContent = next ? `${next} →` : "";

            const pos = state.idx + 1;
            els.readerMeta.textContent = `${wc.toLocaleString()} words loaded`;
            els.posLabel.textContent = `Word ${pos.toLocaleString()} / ${wc.toLocaleString()}`;

            // progress
            els.seek.max = wc - 1;
            els.seek.value = state.idx;
            const pct = (state.idx / Math.max(1, wc - 1)) * 100;
            els.progressFill.style.width = `${pct}%`;

            // ETA (based on remaining words; ignore smart pauses)
            const remaining = wc - state.idx;
            const remainingMin = remaining / state.wpm;
            els.etaLabel.textContent = `ETA: ${formatMinutes(remainingMin)}`;

            // session label
            if (state.playing) {
                const now = performance.now();
                const elapsed = state.elapsedMs + (state.startedAt ? (now - state.startedAt) : 0);
                els.sessionLabel.textContent = `Playing • elapsed ${formatDuration(elapsed)}`;
            } else {
                const elapsed = state.elapsedMs;
                els.sessionLabel.textContent = elapsed ? `Paused • elapsed ${formatDuration(elapsed)}` : "Not started";
            }

            renderFullTextMaybe(false);
        }

        function renderFullTextMaybe(force = false) {
            const show = !!state.highlightText && state.tokens.length;
            els.fullTextWrap.classList.toggle("hidden", !show);
            if (!show) return;

            // If huge, warn and avoid rendering too many spans
            const wc = state.tokens.length;
            const hardLimit = 6000;
            if (wc > hardLimit) {
                els.fullText.innerHTML = `
          <div class="text-xs text-slate-300/80">
            Full-text highlight is disabled for very large inputs (${wc.toLocaleString()} words).\n
            <div class="mt-2">
              Tip: disable “Show full text with highlight” or split your text.
            </div>
          </div>`;
                return;
            }

            const needsRender = force || !els.fullText.dataset.rendered;
            if (needsRender) {
                const frag = document.createDocumentFragment();
                for (let i = 0; i < wc; i++) {
                    const span = document.createElement("span");
                    span.textContent = state.tokens[i] + " ";
                    span.dataset.i = String(i);
                    span.className = "rounded px-0.5";
                    frag.appendChild(span);
                }
                els.fullText.innerHTML = "";
                els.fullText.appendChild(frag);
                els.fullText.dataset.rendered = "1";
            }

            // highlight current
            const prevActive = els.fullText.querySelector("span[data-active='1']");
            if (prevActive) {
                prevActive.dataset.active = "0";
                prevActive.classList.remove("bg-indigo-500/25", "text-slate-50");
            }

            const active = els.fullText.querySelector(`span[data-i='${state.idx}']`);
            if (active) {
                active.dataset.active = "1";
                active.classList.add("bg-indigo-500/25", "text-slate-50");
                // keep in view
                active.scrollIntoView({ block: "nearest", inline: "nearest" });
            }
        }

        function renderBookmarks() {
            const list = state.bookmarks;
            els.bookmarkList.innerHTML = "";
            if (!list.length) {
                els.bookmarkHint.textContent = "Save your place and jump back later.";
                return;
            }
            els.bookmarkHint.textContent = `${list.length} bookmark${list.length > 1 ? 's' : ''}`;

            for (const bm of list.slice().reverse()) {
                const item = document.createElement("div");
                item.className = "flex items-center justify-between gap-2 rounded-xl border border-white/10 bg-slate-950/30 p-2";

                const left = document.createElement("div");
                left.className = "min-w-0";
                const title = document.createElement("div");
                title.className = "text-sm text-slate-100 font-medium truncate";
                title.textContent = bm.name;
                const meta = document.createElement("div");
                meta.className = "text-[11px] text-slate-300/80";
                meta.textContent = `Word ${(bm.idx + 1).toLocaleString()} • ${new Date(bm.createdAt).toLocaleString()}`;
                left.appendChild(title);
                left.appendChild(meta);

                const right = document.createElement("div");
                right.className = "flex items-center gap-2";

                const go = document.createElement("button");
                go.className = "focus-ring rounded-lg bg-indigo-600/90 hover:bg-indigo-600 px-2 py-1 text-xs font-medium";
                go.textContent = "Go";
                go.onclick = () => { seekTo(bm.idx); toast("Jumped to bookmark"); };

                const del = document.createElement("button");
                del.className = "focus-ring rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 px-2 py-1 text-xs";
                del.textContent = "Delete";
                del.onclick = () => {
                    state.bookmarks = state.bookmarks.filter(x => x.createdAt !== bm.createdAt);
                    saveState();
                    renderBookmarks();
                    toast("Bookmark deleted");
                };

                right.appendChild(go);
                right.appendChild(del);

                item.appendChild(left);
                item.appendChild(right);
                els.bookmarkList.appendChild(item);
            }
        }

        // ---------- Playback ----------
        function setPlaying(playing) {
            state.playing = playing;
            els.btnPlay.classList.toggle("hidden", playing);
            els.btnPause.classList.toggle("hidden", !playing);

            if (playing) {
                if (!state.startedAt) state.startedAt = performance.now();
                if (state.pausedAt) {
                    // resume
                    state.pausedAt = null;
                }
                tick();
            } else {
                // pause
                clearTimeout(state.timer);
                state.timer = null;
                if (state.startedAt) {
                    const now = performance.now();
                    state.elapsedMs += (now - state.startedAt);
                    state.startedAt = null;
                    state.pausedAt = now;
                }
                renderReader();
            }
        }

        function stopPlayback() {
            clearTimeout(state.timer);
            state.timer = null;
            state.playing = false;
            state.startedAt = null;
            state.pausedAt = null;
            state.elapsedMs = 0;
            els.btnPlay.classList.remove("hidden");
            els.btnPause.classList.add("hidden");
            renderReader();
        }

        function tick() {
            if (!state.playing) return;
            const wc = state.tokens.length;
            if (!wc) { setPlaying(false); return; }

            // End condition: if at last word, stop after showing it
            if (state.idx >= wc) {
                setPlaying(false);
                return;
            }

            renderReader();
            const lastTokenInChunk = state.tokens[Math.min(state.idx + state.chunk - 1, wc - 1)] || "";
            const interval = computeIntervalMs(lastTokenInChunk);

            state.timer = setTimeout(() => {
                state.idx = Math.min(state.idx + state.chunk, wc - 1);
                if (state.idx >= wc - 1) {
                    // render final word and pause
                    renderReader();
                    setPlaying(false);
                    toast("Finished");
                    saveState();
                    return;
                }
                tick();
            }, interval);
        }

        function seekTo(i) {
            const wc = state.tokens.length;
            if (!wc) return;
            state.idx = clamp(Number(i) || 0, 0, wc - 1);
            renderReader();
        }

        function step(n) {
            seekTo(state.idx + n);
        }

        function jump(n) {
            seekTo(state.idx + n);
        }

        // ---------- Import handlers ----------
        async function importTxtFile(file) {
            els.importStatus.textContent = `Importing TXT: ${file.name}…`;
            const text = await file.text();
            els.textInput.value = text;
            els.importStatus.textContent = `Imported TXT: ${file.name} (${Math.round(file.size / 1024)} KB).`;
            toast("TXT imported");
        }

        async function importPdfFile(file) {
            els.importStatus.textContent = `Importing PDF: ${file.name}…`;
            toast("Parsing PDF…");

            const buf = await file.arrayBuffer();
            const loadingTask = pdfjsLib.getDocument({ data: buf });
            const pdf = await loadingTask.promise;

            let all = [];
            for (let p = 1; p <= pdf.numPages; p++) {
                els.importStatus.textContent = `Extracting text from PDF… page ${p}/${pdf.numPages}`;
                const page = await pdf.getPage(p);
                const content = await page.getTextContent();
                const strings = content.items.map(it => it.str);
                // Join with spaces; keep some line breaks between pages
                all.push(strings.join(" "));
            }
            const text = all.join("\n\n");
            els.textInput.value = text;
            els.importStatus.textContent = `Imported PDF: ${file.name} (${pdf.numPages} pages).`;
            toast("PDF imported");
        }

        function handleFile(file) {
            if (!file) return;
            const name = (file.name || "").toLowerCase();
            if (name.endsWith(".txt") || file.type === "text/plain") return importTxtFile(file);
            if (name.endsWith(".pdf") || file.type === "application/pdf") return importPdfFile(file);
            els.importStatus.textContent = "Unsupported file. Please use .txt or .pdf.";
            toast("Unsupported file");
        }

        // ---------- Prepare reader ----------
        function prepareReader() {
            const raw = els.textInput.value || "";
            const tokens = tokenize(raw);
            state.rawText = raw;
            state.tokens = tokens;
            state.idx = 0;
            state.elapsedMs = 0;
            state.startedAt = null;
            state.pausedAt = null;
            setPlaying(false);

            // reset full text rendering
            delete els.fullText.dataset.rendered;

            updateStats();
            renderReader();
            renderBookmarks();

            if (!tokens.length) {
                toast("No text found");
            } else {
                toast("Reader prepared");
            }

            saveState();
        }

        // ---------- Save/load ----------
        function saveState() {
            const data = {
                v: 1,
                text: els.textInput.value || "",
                idx: state.idx,
                wpm: state.wpm,
                chunk: state.chunk,
                wordsPerPage: state.wordsPerPage,
                smartPauses: state.smartPauses,
                fixHyphens: state.fixHyphens,
                stripExtraWhitespace: state.stripExtraWhitespace,
                highlightText: state.highlightText,
                theme: state.theme,
                bookmarks: state.bookmarks.slice(0, 50),
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadState() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return;
            try {
                const data = JSON.parse(raw);
                if (!data || data.v !== 1) return;

                if (typeof data.text === "string") els.textInput.value = data.text;
                state.wpm = clamp(Number(data.wpm) || 400, 60, 1200);
                state.chunk = clamp(Number(data.chunk) || 1, 1, 4);
                state.wordsPerPage = clamp(Number(data.wordsPerPage) || 250, 100, 1000);

                state.smartPauses = !!data.smartPauses;
                state.fixHyphens = !!data.fixHyphens;
                state.stripExtraWhitespace = !!data.stripExtraWhitespace;
                state.highlightText = (data.highlightText ?? true);

                state.theme = data.theme === "light" ? "light" : "dark";
                state.bookmarks = Array.isArray(data.bookmarks) ? data.bookmarks : [];

                // Reflect UI
                els.wpmRange.value = String(state.wpm);
                els.wpmInput.value = String(state.wpm);
                els.chunkSelect.value = String(state.chunk);
                els.wordsPerPage.value = String(state.wordsPerPage);
                els.smartPauses.checked = state.smartPauses;
                els.fixHyphens.checked = state.fixHyphens;
                els.stripExtraWhitespace.checked = state.stripExtraWhitespace;
                els.highlightText.checked = !!state.highlightText;

                applyTheme();

                // Prepare tokens
                state.tokens = tokenize(els.textInput.value || "");
                state.idx = clamp(Number(data.idx) || 0, 0, Math.max(0, state.tokens.length - 1));

                updateStats();
                renderReader();
                renderBookmarks();
            } catch (e) {
                // ignore
            }
        }

        // ---------- Theme / focus ----------
        function applyTheme() {
            const isLight = state.theme === "light";
            document.documentElement.style.colorScheme = isLight ? "light" : "dark";
            document.body.classList.toggle("text-slate-100", !isLight);

            if (isLight) {
                document.body.className = "min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-100 text-slate-900";
            } else {
                document.body.className = "min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-slate-100";
            }

            // The decorative layer is fixed and uses inline style; we keep it but adjust opacity
            const deco = document.querySelector("body > div[aria-hidden='true']");
            if (deco) deco.style.opacity = isLight ? "0.45" : "0.60";

            els.btnTheme.textContent = isLight ? "Dark theme" : "Light theme";
        }

        function setFocusMode(on) {
            state.focus = !!on;
            document.body.classList.toggle("overflow-hidden", state.focus);

            // Hide left column by adding a class and using inline style tweaks
            const left = document.querySelector("main section:nth-child(1)");
            const header = document.querySelector("header");
            if (left) left.classList.toggle("hidden", state.focus);
            if (header) header.classList.toggle("hidden", state.focus);

            // Expand reader card padding for focus
            const readerSection = document.querySelector("main section:nth-child(2)");
            if (readerSection) {
                readerSection.classList.toggle("lg:col-span-5", state.focus);
            }

            els.btnFocus.textContent = state.focus ? "Exit focus" : "Focus mode";
        }

        // ---------- Events ----------
        function bind() {
            // Defaults
            els.wpmRange.value = String(state.wpm);
            els.wpmInput.value = String(state.wpm);
            els.wordsPerPage.value = String(state.wordsPerPage);
            els.smartPauses.checked = state.smartPauses;
            els.fixHyphens.checked = state.fixHyphens;
            els.stripExtraWhitespace.checked = state.stripExtraWhitespace;
            els.highlightText.checked = state.highlightText;

            updateStats();
            renderReader();
            renderBookmarks();
            applyTheme();

            // Examples
            els.btnExample1.addEventListener("click", () => {
                els.textInput.value = EXAMPLES.ex1;
                toast("Loaded example 1");
                prepareReader();
            });
            els.btnExample2.addEventListener("click", () => {
                els.textInput.value = EXAMPLES.ex2;
                toast("Loaded example 2");
                prepareReader();
            });
            els.btnExample3.addEventListener("click", () => {
                els.textInput.value = EXAMPLES.ex3;
                toast("Loaded example 3");
                prepareReader();
            });

            // Prepare
            els.btnPrepare.addEventListener("click", prepareReader);

            // Clear
            els.btnClear.addEventListener("click", () => {
                setPlaying(false);
                els.textInput.value = "";
                state.tokens = [];
                state.idx = 0;
                state.bookmarks = [];
                delete els.fullText.dataset.rendered;
                updateStats();
                renderReader();
                renderBookmarks();
                saveState();
                toast("Cleared");
            });

            // Copy
            els.btnCopy.addEventListener("click", async () => {
                try {
                    await navigator.clipboard.writeText(els.textInput.value || "");
                    toast("Copied to clipboard");
                } catch (e) {
                    toast("Copy failed (browser permission)");
                }
            });

            // Download
            els.btnDownload.addEventListener("click", () => {
                const blob = new Blob([els.textInput.value || ""], { type: "text/plain;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "flashreader.txt";
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                toast("Downloaded TXT");
            });

            // WPM
            function setWpm(v) {
                state.wpm = clamp(Math.round(Number(v) || 400), 60, 1200);
                els.wpmRange.value = String(state.wpm);
                els.wpmInput.value = String(state.wpm);
                updateStats();
                renderReader();
                saveState();
            }
            els.wpmRange.addEventListener("input", (e) => setWpm(e.target.value));
            els.wpmInput.addEventListener("change", (e) => setWpm(e.target.value));

            document.querySelectorAll("button.preset").forEach(btn => {
                btn.addEventListener("click", () => setWpm(btn.dataset.preset));
            });

            // Chunk / words per page
            els.chunkSelect.addEventListener("change", (e) => {
                state.chunk = clamp(Number(e.target.value) || 1, 1, 4);
                updateStats();
                renderReader();
                saveState();
            });
            els.wordsPerPage.addEventListener("change", (e) => {
                state.wordsPerPage = clamp(Number(e.target.value) || 250, 100, 1000);
                updateStats();
                renderReader();
                saveState();
            });

            // Toggles
            const bindToggle = (el, key) => {
                el.addEventListener("change", () => {
                    state[key] = el.checked;
                    // Re-tokenize if text normalization changed
                    if (key === "fixHyphens" || key === "stripExtraWhitespace") {
                        state.tokens = tokenize(els.textInput.value || "");
                        state.idx = clamp(state.idx, 0, Math.max(0, state.tokens.length - 1));
                        delete els.fullText.dataset.rendered;
                    }
                    if (key === "highlightText") {
                        delete els.fullText.dataset.rendered;
                    }
                    updateStats();
                    renderReader();
                    saveState();
                });
            };
            bindToggle(els.smartPauses, "smartPauses");
            bindToggle(els.fixHyphens, "fixHyphens");
            bindToggle(els.stripExtraWhitespace, "stripExtraWhitespace");
            bindToggle(els.highlightText, "highlightText");

            // Re-render full text
            els.btnReRender.addEventListener("click", () => {
                delete els.fullText.dataset.rendered;
                renderFullTextMaybe(true);
                toast("Re-rendered");
            });

            // Playback buttons
            els.btnPlay.addEventListener("click", () => {
                if (!state.tokens.length) prepareReader();
                if (!state.tokens.length) return;
                setPlaying(true);
                saveState();
            });
            els.btnPause.addEventListener("click", () => { setPlaying(false); saveState(); });
            els.btnRestart.addEventListener("click", () => {
                setPlaying(false);
                state.idx = 0;
                state.elapsedMs = 0;
                state.startedAt = null;
                state.pausedAt = null;
                renderReader();
                saveState();
                toast("Restarted");
            });
            els.btnBack.addEventListener("click", () => jump(-state.chunk));
            els.btnForward.addEventListener("click", () => jump(state.chunk));

            // Tools
            els.btnStepBack.addEventListener("click", () => step(-1));
            els.btnStepForward.addEventListener("click", () => step(1));
            els.btnJumpBack.addEventListener("click", () => jump(-10));
            els.btnJumpForward.addEventListener("click", () => jump(10));

            // Seek
            els.seek.addEventListener("input", (e) => {
                seekTo(e.target.value);
            });
            els.progressBar.addEventListener("click", (e) => {
                const rect = els.progressBar.getBoundingClientRect();
                const x = (e.clientX - rect.left) / rect.width;
                const wc = state.tokens.length;
                if (!wc) return;
                const i = Math.round(x * (wc - 1));
                seekTo(i);
            });

            // Bookmarks
            function addBookmark() {
                if (!state.tokens.length) return toast("Load text first");
                const name = `Bookmark @ ${(state.idx + 1).toLocaleString()}`;
                state.bookmarks.push({ name, idx: state.idx, createdAt: Date.now() });
                // Keep last 20
                if (state.bookmarks.length > 20) state.bookmarks = state.bookmarks.slice(-20);
                renderBookmarks();
                saveState();
                toast("Bookmarked");
            }
            els.btnMark.addEventListener("click", addBookmark);

            // Save
            els.btnSave.addEventListener("click", () => { saveState(); toast("Saved"); });

            // Theme & focus
            els.btnTheme.addEventListener("click", () => {
                state.theme = state.theme === "dark" ? "light" : "dark";
                applyTheme();
                saveState();
                toast("Theme updated");
            });

            els.btnFocus.addEventListener("click", () => {
                setFocusMode(!state.focus);
                toast(state.focus ? "Focus mode" : "Exited focus");
            });

            // Help modal
            els.btnHelp.addEventListener("click", (e) => {
                e.preventDefault();
                els.modalHelp.classList.remove("hidden");
            });
            els.modalHelp.addEventListener("click", (e) => {
                if (e.target && e.target.dataset && e.target.dataset.close) {
                    els.modalHelp.classList.add("hidden");
                }
            });

            // Tap tempo
            els.btnTap.addEventListener("click", () => {
                const now = performance.now();
                if (state.tap.lastTap && (now - state.tap.lastTap) > 2000) {
                    state.tap.times = [];
                }
                state.tap.lastTap = now;
                state.tap.times.push(now);
                if (state.tap.times.length > 8) state.tap.times.shift();

                if (state.tap.times.length >= 3) {
                    const diffs = [];
                    for (let i = 1; i < state.tap.times.length; i++) diffs.push(state.tap.times[i] - state.tap.times[i - 1]);
                    const avg = diffs.reduce((a, b) => a + b, 0) / diffs.length;
                    const wpm = Math.round(60000 / avg);
                    // clamp to sane range
                    const final = clamp(wpm, 60, 1200);
                    els.wpmRange.value = String(final);
                    els.wpmInput.value = String(final);
                    state.wpm = final;
                    updateStats();
                    renderReader();
                    saveState();
                    toast(`Tap tempo: ${final} WPM`);
                } else {
                    toast("Tap 3+ times to set WPM");
                }
            });

            // Text input changes: update stats lightly
            let tmr;
            els.textInput.addEventListener("input", () => {
                clearTimeout(tmr);
                tmr = setTimeout(() => {
                    // don't reset index; just recompute tokens count from input for preview
                    state.tokens = tokenize(els.textInput.value || "");
                    state.idx = clamp(state.idx, 0, Math.max(0, state.tokens.length - 1));
                    delete els.fullText.dataset.rendered;
                    updateStats();
                    renderReader();
                    saveState();
                }, 250);
            });

            // Drag & drop
            ;["dragenter", "dragover"].forEach(evt => {
                els.dropzone.addEventListener(evt, (e) => {
                    e.preventDefault();
                    els.dropzone.classList.add("border-indigo-400/60");
                });
            });
            ;["dragleave", "drop"].forEach(evt => {
                els.dropzone.addEventListener(evt, (e) => {
                    e.preventDefault();
                    els.dropzone.classList.remove("border-indigo-400/60");
                });
            });
            els.dropzone.addEventListener("drop", (e) => {
                const file = e.dataTransfer?.files?.[0];
                if (file) handleFile(file);
            });

            // File inputs
            els.fileTxt.addEventListener("change", (e) => handleFile(e.target.files?.[0]));
            els.filePdf.addEventListener("change", (e) => handleFile(e.target.files?.[0]));

            // Keyboard shortcuts
            document.addEventListener("keydown", (e) => {
                if (els.modalHelp && !els.modalHelp.classList.contains("hidden")) {
                    if (e.key === "Escape") els.modalHelp.classList.add("hidden");
                    return;
                }

                if (isTypingTarget(e)) return;

                if (e.key === " ") {
                    e.preventDefault();
                    if (!state.tokens.length) prepareReader();
                    if (!state.tokens.length) return;
                    setPlaying(!state.playing);
                    saveState();
                    return;
                }

                if (e.key === "ArrowLeft") {
                    e.preventDefault();
                    e.shiftKey ? jump(-10) : step(-1);
                    saveState();
                    return;
                }
                if (e.key === "ArrowRight") {
                    e.preventDefault();
                    e.shiftKey ? jump(10) : step(1);
                    saveState();
                    return;
                }
                if (e.key === "ArrowUp") {
                    e.preventDefault();
                    const v = clamp(state.wpm + 10, 60, 1200);
                    els.wpmRange.value = String(v);
                    els.wpmInput.value = String(v);
                    state.wpm = v;
                    updateStats();
                    renderReader();
                    saveState();
                    toast(`${v} WPM`);
                    return;
                }
                if (e.key === "ArrowDown") {
                    e.preventDefault();
                    const v = clamp(state.wpm - 10, 60, 1200);
                    els.wpmRange.value = String(v);
                    els.wpmInput.value = String(v);
                    state.wpm = v;
                    updateStats();
                    renderReader();
                    saveState();
                    toast(`${v} WPM`);
                    return;
                }
                if (e.key.toLowerCase() === "r") {
                    e.preventDefault();
                    setPlaying(false);
                    seekTo(0);
                    state.elapsedMs = 0;
                    state.startedAt = null;
                    state.pausedAt = null;
                    renderReader();
                    saveState();
                    toast("Restarted");
                    return;
                }
                if (e.key.toLowerCase() === "b") {
                    e.preventDefault();
                    els.btnMark.click();
                    return;
                }
                if (e.key.toLowerCase() === "f") {
                    e.preventDefault();
                    setFocusMode(!state.focus);
                    return;
                }
                if (e.key === "Escape") {
                    if (state.focus) setFocusMode(false);
                    return;
                }
            });

            // Before unload: persist
            window.addEventListener("beforeunload", () => saveState());

            // Initial tokenization preview
            state.tokens = tokenize(els.textInput.value || "");
            updateStats();
            renderReader();
        }

        // Boot
        loadState();
        bind();

    </script>
</body>

</html>