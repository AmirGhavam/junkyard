<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
        }

        /* Custom scrollbar for transaction list */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="text-gray-800">

    <!-- Navigation -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fa-solid fa-wallet text-indigo-600 text-2xl mr-3"></i>
                    <span class="font-bold text-xl text-gray-900">FinanceTracker</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="resetData()" class="text-sm text-gray-500 hover:text-red-500 transition-colors">
                        <i class="fa-solid fa-rotate-right mr-1"></i> Reset Data
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card border-l-4 border-indigo-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Total Balance</p>
                        <p class="text-2xl font-bold text-gray-900 mt-1" id="totalBalance">$0.00</p>
                    </div>
                    <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600">
                        <i class="fa-solid fa-scale-balanced"></i>
                    </div>
                </div>
            </div>
            <div class="card border-l-4 border-emerald-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Total Income</p>
                        <p class="text-2xl font-bold text-emerald-600 mt-1" id="totalIncome">$0.00</p>
                    </div>
                    <div class="p-2 bg-emerald-50 rounded-lg text-emerald-600">
                        <i class="fa-solid fa-arrow-trend-up"></i>
                    </div>
                </div>
            </div>
            <div class="card border-l-4 border-rose-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Total Expenses</p>
                        <p class="text-2xl font-bold text-rose-600 mt-1" id="totalExpense">$0.00</p>
                    </div>
                    <div class="p-2 bg-rose-50 rounded-lg text-rose-600">
                        <i class="fa-solid fa-arrow-trend-down"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Left Column: Input Form & Budgets -->
            <div class="space-y-8">

                <!-- Add Transaction Form -->
                <div class="card">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fa-solid fa-plus-circle mr-2 text-indigo-500"></i> Add Transaction
                    </h2>
                    <form id="transactionForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="cursor-pointer">
                                    <input type="radio" name="type" value="expense" class="peer sr-only" checked>
                                    <div
                                        class="text-center py-2 rounded-md border border-gray-300 peer-checked:bg-rose-50 peer-checked:border-rose-500 peer-checked:text-rose-700 text-sm font-medium transition-all">
                                        Expense
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="type" value="income" class="peer sr-only">
                                    <div
                                        class="text-center py-2 rounded-md border border-gray-300 peer-checked:bg-emerald-50 peer-checked:border-emerald-500 peer-checked:text-emerald-700 text-sm font-medium transition-all">
                                        Income
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <input type="text" id="descInput" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="e.g. Grocery Shopping">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                                <input type="number" id="amountInput" required min="0.01" step="0.01"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                    placeholder="0.00">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                <input type="date" id="dateInput" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                            <select id="categoryInput"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                                <!-- Populated by JS -->
                            </select>
                        </div>

                        <button type="submit"
                            class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors font-medium shadow-sm">
                            Add Transaction
                        </button>
                    </form>
                </div>

                <!-- Budget Limits -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                            <i class="fa-solid fa-bullseye mr-2 text-indigo-500"></i> Monthly Budgets
                        </h2>
                        <button onclick="toggleBudgetEdit()"
                            class="text-xs text-indigo-600 font-medium hover:underline">Edit Limits</button>
                    </div>
                    <div id="budgetContainer" class="space-y-4 max-h-[400px] overflow-y-auto pr-2">
                        <!-- Populated by JS -->
                    </div>
                </div>

            </div>

            <!-- Middle & Right Columns: Charts & History -->
            <div class="lg:col-span-2 space-y-8">

                <!-- Charts Section -->
                <div class="card">
                    <div class="flex border-b border-gray-200 mb-4">
                        <button
                            class="px-4 py-2 text-sm font-medium text-indigo-600 border-b-2 border-indigo-600 focus:outline-none"
                            id="tabBreakdown" onclick="switchTab('breakdown')">Category Breakdown</button>
                        <button
                            class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 focus:outline-none"
                            id="tabTrends" onclick="switchTab('trends')">Monthly Trends</button>
                    </div>
                    <div class="h-80 w-full relative" id="chartContainer">
                        <canvas id="breakdownChart"></canvas>
                        <canvas id="trendsChart" class="hidden"></canvas>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="card">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                            <i class="fa-solid fa-list-ul mr-2 text-indigo-500"></i> Recent Transactions
                        </h2>
                        <div class="flex space-x-2 w-full sm:w-auto">
                            <select id="filterType" onchange="renderTransactions()"
                                class="text-sm border border-gray-300 rounded-md px-2 py-1 focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                <option value="all">All Types</option>
                                <option value="income">Income</option>
                                <option value="expense">Expense</option>
                            </select>
                            <select id="filterCategory" onchange="renderTransactions()"
                                class="text-sm border border-gray-300 rounded-md px-2 py-1 focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                <option value="all">All Categories</option>
                                <!-- Populated by JS -->
                            </select>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Date</th>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Description</th>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Category</th>
                                    <th
                                        class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Amount</th>
                                    <th
                                        class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Action</th>
                                </tr>
                            </thead>
                            <tbody id="transactionList" class="bg-white divide-y divide-gray-200">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <div id="noTransactions" class="hidden py-8 text-center text-gray-500">
                        No transactions found matching your filters.
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Modal for Editing Budgets -->
    <div id="budgetModal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative bg-white rounded-lg shadow-xl p-6 w-full max-w-md m-4">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Edit Monthly Budgets</h3>
            <div id="budgetInputs" class="space-y-3 max-h-[60vh] overflow-y-auto mb-4">
                <!-- Inputs generated by JS -->
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="toggleBudgetEdit()"
                    class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 text-sm font-medium">Cancel</button>
                <button onclick="saveBudgets()"
                    class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm font-medium">Save
                    Changes</button>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration & State ---
        const CATEGORIES = {
            expense: [
                { id: 'housing', name: 'Housing', icon: 'fa-house' },
                { id: 'food', name: 'Food & Dining', icon: 'fa-utensils' },
                { id: 'transport', name: 'Transportation', icon: 'fa-car' },
                { id: 'utilities', name: 'Utilities', icon: 'fa-bolt' },
                { id: 'entertainment', name: 'Entertainment', icon: 'fa-film' },
                { id: 'healthcare', name: 'Healthcare', icon: 'fa-heart-pulse' },
                { id: 'shopping', name: 'Shopping', icon: 'fa-bag-shopping' },
                { id: 'personal', name: 'Personal Care', icon: 'fa-spa' },
                { id: 'other_expense', name: 'Other Expense', icon: 'fa-receipt' }
            ],
            income: [
                { id: 'salary', name: 'Salary', icon: 'fa-money-bill-wave' },
                { id: 'freelance', name: 'Freelance', icon: 'fa-laptop-code' },
                { id: 'investments', name: 'Investments', icon: 'fa-chart-line' },
                { id: 'gifts', name: 'Gifts', icon: 'fa-gift' },
                { id: 'other_income', name: 'Other Income', icon: 'fa-hand-holding-dollar' }
            ]
        };

        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let budgetLimits = JSON.parse(localStorage.getItem('budgetLimits')) || {
            'housing': 1200,
            'food': 400,
            'transport': 200,
            'utilities': 150,
            'entertainment': 100,
            'healthcare': 100,
            'shopping': 150,
            'personal': 50,
            'other_expense': 100
        };

        // Initialize Charts
        let breakdownChart = null;
        let trendsChart = null;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set default date to today
            document.getElementById('dateInput').valueAsDate = new Date();

            // Populate Category Selects
            updateCategoryOptions();

            // Add event listener for type toggle
            document.querySelectorAll('input[name="type"]').forEach(radio => {
                radio.addEventListener('change', updateCategoryOptions);
            });

            // Check if it's first run and add dummy data if empty
            if (transactions.length === 0) {
                addDummyData();
            }

            // Initial Render
            renderDashboard();
            renderTransactionList();
            renderBudgets();
            initCharts();
        });

        function addDummyData() {
            const today = new Date();

            const formatDate = (y, m, d) => {
                const date = new Date(y, m, d);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const curY = today.getFullYear();
            const curM = today.getMonth();

            const dummyData = [
                { id: '1', type: 'income', description: 'Monthly Salary', amount: 3500, date: formatDate(curY, curM, 1), categoryId: 'salary', categoryName: 'Salary' },
                { id: '2', type: 'expense', description: 'Rent Payment', amount: 1200, date: formatDate(curY, curM, 2), categoryId: 'housing', categoryName: 'Housing' },
                { id: '3', type: 'expense', description: 'Weekly Groceries', amount: 156.40, date: formatDate(curY, curM, 5), categoryId: 'food', categoryName: 'Food & Dining' },
                { id: '4', type: 'expense', description: 'Gas Station', amount: 45.00, date: formatDate(curY, curM, 7), categoryId: 'transport', categoryName: 'Transportation' },
                { id: '5', type: 'expense', description: 'Netflix Subscription', amount: 15.99, date: formatDate(curY, curM, 10), categoryId: 'entertainment', categoryName: 'Entertainment' },
                { id: '6', type: 'expense', description: 'Restaurant Dinner', amount: 85.50, date: formatDate(curY, curM, 12), categoryId: 'food', categoryName: 'Food & Dining' },
                { id: '7', type: 'income', description: 'Freelance Project', amount: 650, date: formatDate(curY, curM, 15), categoryId: 'freelance', categoryName: 'Freelance' },
                { id: '8', type: 'expense', description: 'Electricity Bill', amount: 120.30, date: formatDate(curY, curM, 18), categoryId: 'utilities', categoryName: 'Utilities' },
                { id: '9', type: 'expense', description: 'New Headphones', amount: 199.99, date: formatDate(curY, curM, 20), categoryId: 'shopping', categoryName: 'Shopping' },
                // Previous Month Data for trends
                { id: '10', type: 'income', description: 'Last Month Salary', amount: 3500, date: formatDate(curY, curM - 1, 1), categoryId: 'salary', categoryName: 'Salary' },
                { id: '11', type: 'expense', description: 'Last Month Rent', amount: 1200, date: formatDate(curY, curM - 1, 2), categoryId: 'housing', categoryName: 'Housing' },
                { id: '12', type: 'expense', description: 'Car Maintenance', amount: 350, date: formatDate(curY, curM - 1, 15), categoryId: 'transport', categoryName: 'Transportation' }
            ];

            transactions = dummyData;
            saveData();
        }

        function updateCategoryOptions() {
            const type = document.querySelector('input[name="type"]:checked').value;
            const select = document.getElementById('categoryInput');
            const filterSelect = document.getElementById('filterCategory');

            select.innerHTML = '';

            // Re-populate the main input select
            CATEGORIES[type].forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                select.appendChild(option);
            });

            // Re-populate the filter select (include all categories regardless of type, or dynamic?)
            // For filter, let's keep all categories available but grouped
            filterSelect.innerHTML = '<option value="all">All Categories</option>';

            const groupExpense = document.createElement('optgroup');
            groupExpense.label = "Expenses";
            CATEGORIES.expense.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.id;
                opt.textContent = cat.name;
                groupExpense.appendChild(opt);
            });
            filterSelect.appendChild(groupExpense);

            const groupIncome = document.createElement('optgroup');
            groupIncome.label = "Income";
            CATEGORIES.income.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.id;
                opt.textContent = cat.name;
                groupIncome.appendChild(opt);
            });
            filterSelect.appendChild(groupIncome);
        }

        // --- Core Functions ---

        document.getElementById('transactionForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const type = document.querySelector('input[name="type"]:checked').value;
            const description = document.getElementById('descInput').value;
            const amount = parseFloat(document.getElementById('amountInput').value);
            const date = document.getElementById('dateInput').value;
            const categoryId = document.getElementById('categoryInput').value;

            // Find category details
            const categoryList = type === 'expense' ? CATEGORIES.expense : CATEGORIES.income;
            const category = categoryList.find(c => c.id === categoryId);

            const newTransaction = {
                id: Date.now().toString(),
                type,
                description,
                amount,
                date,
                categoryId,
                categoryName: category.name
            };

            transactions.unshift(newTransaction);
            saveData();

            // Reset form but keep date
            const currDate = document.getElementById('dateInput').value;
            document.getElementById('transactionForm').reset();
            document.getElementById('dateInput').value = currDate;
            // Restore radio button default
            document.querySelector(`input[name="type"][value="${type}"]`).checked = true;
            updateCategoryOptions();
            document.getElementById('categoryInput').value = categoryId; // Keep last category selection

            renderDashboard();
            renderTransactionList();
            renderBudgets();
            updateCharts();
        });

        function deleteTransaction(id) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                transactions = transactions.filter(t => t.id !== id);
                saveData();
                renderDashboard();
                renderTransactionList();
                renderBudgets();
                updateCharts();
            }
        }

        function saveData() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('budgetLimits', JSON.stringify(budgetLimits));
        }

        function resetData() {
            if (confirm('This will delete all your transactions. Continue?')) {
                localStorage.removeItem('transactions');
                // We keep budgets preference
                transactions = [];
                location.reload();
            }
        }

        // --- Rendering ---

        function renderDashboard() {
            const income = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);

            const expense = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);

            const balance = income - expense;

            document.getElementById('totalBalance').textContent = formatCurrency(balance);
            document.getElementById('totalIncome').textContent = formatCurrency(income);
            document.getElementById('totalExpense').textContent = formatCurrency(expense);
        }

        function renderTransactionList() {
            const list = document.getElementById('transactionList');
            const filterType = document.getElementById('filterType').value;
            const filterCategory = document.getElementById('filterCategory').value;
            const noData = document.getElementById('noTransactions');

            list.innerHTML = '';

            const filtered = transactions.filter(t => {
                if (filterType !== 'all' && t.type !== filterType) return false;
                if (filterCategory !== 'all' && t.categoryId !== filterCategory) return false;
                return true;
            });

            if (filtered.length === 0) {
                noData.classList.remove('hidden');
                return;
            } else {
                noData.classList.add('hidden');
            }

            filtered.forEach(t => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition-colors duration-150";
                const isExpense = t.type === 'expense';

                // Find icon
                let iconClass = 'fa-circle-question';
                const allCats = [...CATEGORIES.expense, ...CATEGORIES.income];
                const catObj = allCats.find(c => c.id === t.categoryId);
                if (catObj) iconClass = catObj.icon;

                const formattedDate = new Date(t.date + 'T12:00:00').toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });

                tr.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${formattedDate}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${t.description}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            <i class="fa-solid ${iconClass} mr-1"></i> ${t.categoryName}
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-right font-bold ${isExpense ? 'text-rose-600' : 'text-emerald-600'}">
                        ${isExpense ? '-' : '+'} ${formatCurrency(t.amount)}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-center text-sm font-medium">
                        <button onclick="deleteTransaction('${t.id}')" class="text-gray-400 hover:text-red-600 transition-colors">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                `;
                list.appendChild(tr);
            });
        }

        function renderBudgets() {
            const container = document.getElementById('budgetContainer');
            container.innerHTML = '';

            // Calculate expense per category for the current month
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const expensesByCategory = {};

            transactions.forEach(t => {
                const [y, m, d] = t.date.split('-').map(Number);
                // m is 1-based from split, currentMonth is 0-based
                if (t.type === 'expense' && (m - 1) === currentMonth && y === currentYear) {
                    expensesByCategory[t.categoryId] = (expensesByCategory[t.categoryId] || 0) + t.amount;
                }
            });

            CATEGORIES.expense.forEach(cat => {
                const limit = budgetLimits[cat.id] || 0;
                if (limit === 0) return; // Skip if no budget set

                const spent = expensesByCategory[cat.id] || 0;
                const percentage = Math.min(100, Math.round((spent / limit) * 100));

                let colorClass = 'bg-indigo-600';
                if (percentage >= 100) colorClass = 'bg-red-600';
                else if (percentage >= 80) colorClass = 'bg-orange-500';

                const div = document.createElement('div');
                div.className = 'bg-gray-50 p-3 rounded-lg border border-gray-100';
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-gray-700 flex items-center">
                            <i class="fa-solid ${cat.icon} w-5 text-gray-400"></i> ${cat.name}
                        </span>
                        <span class="text-xs font-medium text-gray-500">${formatCurrency(spent)} / ${formatCurrency(limit)}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="${colorClass} h-2.5 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                    </div>
                    <p class="text-xs text-right mt-1 ${percentage >= 100 ? 'text-red-500 font-bold' : 'text-gray-400'}">
                        ${percentage}% used
                    </p>
                `;
                container.appendChild(div);
            });

            if (container.children.length === 0) {
                container.innerHTML = `<p class="text-center text-sm text-gray-400 py-4">No budget limits set. Click "Edit Limits" to start.</p>`;
            }
        }

        // --- Budget Modal Functions ---

        function toggleBudgetEdit() {
            const modal = document.getElementById('budgetModal');
            const inputsContainer = document.getElementById('budgetInputs');

            if (modal.classList.contains('hidden')) {
                // Open modal
                inputsContainer.innerHTML = '';
                CATEGORIES.expense.forEach(cat => {
                    const div = document.createElement('div');
                    div.className = "flex items-center justify-between";
                    div.innerHTML = `
                        <label class="text-sm font-medium text-gray-700 w-1/2">${cat.name}</label>
                        <input type="number" id="budget_input_${cat.id}" value="${budgetLimits[cat.id] || 0}" 
                            class="w-1/2 px-3 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500">
                    `;
                    inputsContainer.appendChild(div);
                });
                modal.classList.remove('hidden');
            } else {
                // Close modal
                modal.classList.add('hidden');
            }
        }

        function saveBudgets() {
            CATEGORIES.expense.forEach(cat => {
                const input = document.getElementById(`budget_input_${cat.id}`);
                if (input) {
                    budgetLimits[cat.id] = parseFloat(input.value) || 0;
                }
            });
            saveData();
            renderBudgets();
            toggleBudgetEdit(); // close modal
        }


        // --- Chart Functions ---

        function initCharts() {
            // Doughnut Chart
            const ctxBreakdown = document.getElementById('breakdownChart').getContext('2d');
            breakdownChart = new Chart(ctxBreakdown, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#6366f1', '#ec4899', '#f43f5e', '#f97316', '#eab308',
                            '#84cc16', '#14b8a6', '#06b6d4', '#8b5cf6'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } },
                        title: { display: true, text: 'Expense Breakdown (All Time)' }
                    }
                }
            });

            // Bar Chart (Trends)
            const ctxTrends = document.getElementById('trendsChart').getContext('2d');
            trendsChart = new Chart(ctxTrends, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Income',
                            data: [],
                            backgroundColor: '#10b981',
                            borderRadius: 4
                        },
                        {
                            label: 'Expense',
                            data: [],
                            backgroundColor: '#f43f5e',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f3f4f6' } },
                        x: { grid: { display: false } }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Last 6 Months Trend' }
                    }
                }
            });

            updateCharts();
        }

        function updateCharts() {
            // Update Breakdown Chart (Expenses Only)
            const expenseTotals = {};
            transactions.filter(t => t.type === 'expense').forEach(t => {
                expenseTotals[t.categoryName] = (expenseTotals[t.categoryName] || 0) + t.amount;
            });

            const labels = Object.keys(expenseTotals);
            const data = Object.values(expenseTotals);

            if (labels.length === 0) {
                breakdownChart.data.labels = ['No Data'];
                breakdownChart.data.datasets[0].data = [1];
                breakdownChart.data.datasets[0].backgroundColor = ['#e5e7eb'];
            } else {
                breakdownChart.data.labels = labels;
                breakdownChart.data.datasets[0].data = data;
                breakdownChart.data.datasets[0].backgroundColor = [
                    '#6366f1', '#ec4899', '#f43f5e', '#f97316', '#eab308',
                    '#84cc16', '#14b8a6', '#06b6d4', '#8b5cf6'
                ];
            }
            breakdownChart.update();

            // Update Trends Chart (Last 6 Months)
            const months = [];
            const incomeData = [];
            const expenseData = [];

            const today = new Date();
            for (let i = 5; i >= 0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthName = d.toLocaleString('default', { month: 'short' });
                const year = d.getFullYear(); // needed to filter strictly
                months.push(`${monthName}`);

                // Calculate totals for this specific month/year
                const targetMonth = d.getMonth();
                const targetYear = d.getFullYear();

                const inc = transactions
                    .filter(t => {
                        // Parse YYYY-MM-DD manually to avoid timezone issues
                        const [y, m, d] = t.date.split('-').map(Number);
                        return t.type === 'income' && (m - 1) === targetMonth && y === targetYear;
                    })
                    .reduce((sum, t) => sum + t.amount, 0);

                const exp = transactions
                    .filter(t => {
                        const [y, m, d] = t.date.split('-').map(Number);
                        return t.type === 'expense' && (m - 1) === targetMonth && y === targetYear;
                    })
                    .reduce((sum, t) => sum + t.amount, 0);

                incomeData.push(inc);
                expenseData.push(exp);
            }

            trendsChart.data.labels = months;
            trendsChart.data.datasets[0].data = incomeData;
            trendsChart.data.datasets[1].data = expenseData;
            trendsChart.update();
        }

        function switchTab(tab) {
            const breakdownCanvas = document.getElementById('breakdownChart');
            const trendsCanvas = document.getElementById('trendsChart');
            const tabBreakdown = document.getElementById('tabBreakdown');
            const tabTrends = document.getElementById('tabTrends');

            if (tab === 'breakdown') {
                breakdownCanvas.classList.remove('hidden');
                trendsCanvas.classList.add('hidden');

                tabBreakdown.className = "px-4 py-2 text-sm font-medium text-indigo-600 border-b-2 border-indigo-600 focus:outline-none";
                tabTrends.className = "px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 focus:outline-none";
            } else {
                breakdownCanvas.classList.add('hidden');
                trendsCanvas.classList.remove('hidden');

                tabTrends.className = "px-4 py-2 text-sm font-medium text-indigo-600 border-b-2 border-indigo-600 focus:outline-none";
                tabBreakdown.className = "px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 focus:outline-none";
            }
        }

        // --- Helpers ---
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        }

    </script>
</body>

</html>